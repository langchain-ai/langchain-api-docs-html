
<!DOCTYPE html>

<html data-content_root="../../" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-9B66JQQH2F"></script>
<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-9B66JQQH2F');
    </script>
<title>langchain_ibm.chat_models â€” ðŸ¦œðŸ”— LangChain  documentation</title>
<script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
<!--
    this give us a css class that will be invisible only if js is disabled
  -->
<noscript>
<style>
      .pst-js-only { display: none !important; }

    </style>
</noscript>
<!-- Loaded before other Sphinx assets -->
<link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet"/>
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet"/>
<link href="../../_static/pygments.css?v=8f2a1f02" rel="stylesheet" type="text/css"/>
<link href="../../_static/autodoc_pydantic.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/copybutton.css?v=76b2166b" rel="stylesheet" type="text/css"/>
<link href="../../_static/sphinx-design.min.css?v=95c83b7e" rel="stylesheet" type="text/css"/>
<link href="../../_static/css/custom.css?v=8e9fa5b3" rel="stylesheet" type="text/css"/>
<!-- So that users can add custom icons -->
<script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" rel="preload"/>
<link as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" rel="preload"/>
<script src="../../_static/documentation_options.js?v=3b5cce75"></script>
<script src="../../_static/doctools.js?v=9bcbadda"></script>
<script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
<script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
<script src="../../_static/copybutton.js?v=f281be69"></script>
<script src="../../_static/design-tabs.js?v=f930bc37"></script>
<script>DOCUMENTATION_OPTIONS.pagename = '_modules/langchain_ibm/chat_models';</script>
<link href="../../_static/favicon.png" rel="icon"/>
<link href="../../search.html" rel="search" title="Search"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="en" name="docsearch:language"/>
<meta content="" name="docsearch:version"/>
<meta content="Oct 17, 2025" name="docbuild:last-update"/>
</head>
<body data-bs-root-margin="0px 0px -60%" data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-default-mode="" data-offset="180">
<div class="skip-link d-print-none" id="pst-skip-link"><a href="#main-content">Skip to main content</a></div>
<div id="pst-scroll-pixel-helper"></div>
<button class="btn rounded-pill" id="pst-back-to-top" type="button">
<i class="fa-solid fa-arrow-up"></i>Back to top</button>
<dialog id="pst-search-dialog">
<form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" name="q" placeholder="Search" spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
</dialog>
<div class="pst-async-banner-revealer d-none">
<aside aria-label="Version warning" class="d-none d-print-none" id="bd-header-version-warning"></aside>
</div>
<header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
<button aria-label="Site navigation" class="pst-navbar-icon sidebar-toggle primary-toggle">
<span class="fa-solid fa-bars"></span>
</button>
<div class="navbar-header-items__start">
<div class="navbar-item">
<a class="navbar-brand logo" href="../../index.html">
<img alt="ðŸ¦œðŸ”— LangChain  documentation - Home" class="logo__image only-light" src="../../_static/wordmark-api.svg"/>
<img alt="ðŸ¦œðŸ”— LangChain  documentation - Home" class="logo__image only-dark pst-js-only" src="../../_static/wordmark-api-dark.svg"/>
</a></div>
</div>
<div class="navbar-header-items">
<div class="me-auto navbar-header-items__center">
<div class="navbar-item">
<nav>
<ul class="bd-navbar-elements navbar-nav">
<li class="nav-item">
<a class="nav-link nav-internal" href="../../reference.html">
    Reference
  </a>
</li>
</ul>
</nav></div>
</div>
<div class="navbar-header-items__end">
<div class="navbar-item navbar-persistent--container">
<form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" name="q" placeholder="Search" spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
</div>
<div class="navbar-item"><!-- This will display a link to LangChain docs -->
<head>
<style>
        .text-link {
            text-decoration: none; /* Remove underline */
            color: inherit;        /* Inherit color from parent element */
        }
    </style>
</head>
<body>
<a class="text-link" href="https://python.langchain.com/">Docs</a>
</body></div>
<div class="navbar-item">
<button aria-label="Color mode" class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" data-bs-placement="bottom" data-bs-title="Color mode" data-bs-toggle="tooltip">
<i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light" title="Light"></i>
<i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark" title="Dark"></i>
<i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto" title="System Settings"></i>
</button></div>
<div class="navbar-item"><ul aria-label="Quick Links" class="navbar-icon-links">
<li class="nav-item">
<a class="nav-link pst-navbar-icon" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://github.com/langchain-ai/langchain" rel="noopener" target="_blank" title="GitHub"><i aria-hidden="true" class="fa-brands fa-square-github fa-lg"></i>
<span class="sr-only">GitHub</span></a>
</li>
<li class="nav-item">
<a class="nav-link pst-navbar-icon" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://twitter.com/langchainai" rel="noopener" target="_blank" title="X / Twitter"><i aria-hidden="true" class="fab fa-twitter-square fa-lg"></i>
<span class="sr-only">X / Twitter</span></a>
</li>
</ul></div>
</div>
</div>
<div class="navbar-persistent--mobile">
<form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" name="q" placeholder="Search" spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
</div>
</div>
</header>
<div class="bd-container">
<div class="bd-container__inner bd-page-width">
<dialog id="pst-primary-sidebar-modal"></dialog>
<div class="bd-sidebar-primary bd-sidebar hide-on-wide" id="pst-primary-sidebar">
<div class="sidebar-header-items sidebar-primary__section">
<div class="sidebar-header-items__center">
<div class="navbar-item">
<nav>
<ul class="bd-navbar-elements navbar-nav">
<li class="nav-item">
<a class="nav-link nav-internal" href="../../reference.html">
    Reference
  </a>
</li>
</ul>
</nav></div>
</div>
<div class="sidebar-header-items__end">
<div class="navbar-item"><!-- This will display a link to LangChain docs -->
<head>
<style>
        .text-link {
            text-decoration: none; /* Remove underline */
            color: inherit;        /* Inherit color from parent element */
        }
    </style>
</head>
<body>
<a class="text-link" href="https://python.langchain.com/">Docs</a>
</body></div>
<div class="navbar-item">
<button aria-label="Color mode" class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" data-bs-placement="bottom" data-bs-title="Color mode" data-bs-toggle="tooltip">
<i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light" title="Light"></i>
<i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark" title="Dark"></i>
<i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto" title="System Settings"></i>
</button></div>
<div class="navbar-item"><ul aria-label="Quick Links" class="navbar-icon-links">
<li class="nav-item">
<a class="nav-link pst-navbar-icon" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://github.com/langchain-ai/langchain" rel="noopener" target="_blank" title="GitHub"><i aria-hidden="true" class="fa-brands fa-square-github fa-lg"></i>
<span class="sr-only">GitHub</span></a>
</li>
<li class="nav-item">
<a class="nav-link pst-navbar-icon" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://twitter.com/langchainai" rel="noopener" target="_blank" title="X / Twitter"><i aria-hidden="true" class="fab fa-twitter-square fa-lg"></i>
<span class="sr-only">X / Twitter</span></a>
</li>
</ul></div>
</div>
</div>
<div class="sidebar-primary-items__end sidebar-primary__section">
<div class="sidebar-primary-item">
<div class="flat" data-ea-manual="true" data-ea-publisher="readthedocs" data-ea-type="readthedocs-sidebar" id="ethical-ad-placement">
</div></div>
</div>
</div>
<main class="bd-main" id="main-content" role="main">
<div class="bd-content">
<div class="bd-article-container">
<div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
<div class="header-article-items__start">
<div class="header-article-item">
<nav aria-label="Breadcrumb" class="d-print-none">
<ul class="bd-breadcrumbs">
<li class="breadcrumb-item breadcrumb-home">
<a aria-label="Home" class="nav-link" href="../../index.html">
<i class="fa-solid fa-home"></i>
</a>
</li>
<li class="breadcrumb-item"><a class="nav-link" href="../index.html">Module code</a></li>
<li aria-current="page" class="breadcrumb-item active"><span class="ellipsis">langchain_ibm.chat_models</span></li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<div id="searchbox"></div>
<article class="bd-article">
<h1>Source code for langchain_ibm.chat_models</h1><div class="highlight"><pre>
<span></span><span class="sd">"""IBM watsonx.ai chat wrapper."""</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">operator</span><span class="w"> </span><span class="kn">import</span> <span class="n">itemgetter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">AsyncIterator</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Iterator</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Literal</span><span class="p">,</span>
    <span class="n">Mapping</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">TypedDict</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ibm_watsonx_ai</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIClient</span>  <span class="c1"># type: ignore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ibm_watsonx_ai.foundation_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelInference</span>  <span class="c1"># type: ignore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ibm_watsonx_ai.foundation_models.schema</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>  <span class="c1"># type: ignore</span>
    <span class="n">BaseSchema</span><span class="p">,</span>
    <span class="n">TextChatParameters</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ibm_watsonx_ai.gateway</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gateway</span>  <span class="c1"># type: ignore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.callbacks</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AsyncCallbackManagerForLLMRun</span><span class="p">,</span>
    <span class="n">CallbackManagerForLLMRun</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.language_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">LanguageModelInput</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.language_models.chat_models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaseChatModel</span><span class="p">,</span>
    <span class="n">LangSmithParams</span><span class="p">,</span>
    <span class="n">agenerate_from_stream</span><span class="p">,</span>
    <span class="n">generate_from_stream</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AIMessage</span><span class="p">,</span>
    <span class="n">AIMessageChunk</span><span class="p">,</span>
    <span class="n">BaseMessage</span><span class="p">,</span>
    <span class="n">BaseMessageChunk</span><span class="p">,</span>
    <span class="n">ChatMessage</span><span class="p">,</span>
    <span class="n">ChatMessageChunk</span><span class="p">,</span>
    <span class="n">FunctionMessage</span><span class="p">,</span>
    <span class="n">FunctionMessageChunk</span><span class="p">,</span>
    <span class="n">HumanMessage</span><span class="p">,</span>
    <span class="n">HumanMessageChunk</span><span class="p">,</span>
    <span class="n">InvalidToolCall</span><span class="p">,</span>
    <span class="n">SystemMessage</span><span class="p">,</span>
    <span class="n">SystemMessageChunk</span><span class="p">,</span>
    <span class="n">ToolCall</span><span class="p">,</span>
    <span class="n">ToolMessage</span><span class="p">,</span>
    <span class="n">ToolMessageChunk</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages.ai</span><span class="w"> </span><span class="kn">import</span> <span class="n">UsageMetadata</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages.tool</span><span class="w"> </span><span class="kn">import</span> <span class="n">tool_call_chunk</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.output_parsers</span><span class="w"> </span><span class="kn">import</span> <span class="n">JsonOutputParser</span><span class="p">,</span> <span class="n">PydanticOutputParser</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.output_parsers.openai_tools</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">JsonOutputKeyToolsParser</span><span class="p">,</span>
    <span class="n">PydanticToolsParser</span><span class="p">,</span>
    <span class="n">make_invalid_tool_call</span><span class="p">,</span>
    <span class="n">parse_tool_call</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.outputs</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatGeneration</span><span class="p">,</span> <span class="n">ChatGenerationChunk</span><span class="p">,</span> <span class="n">ChatResult</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.runnables</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Runnable</span><span class="p">,</span>
    <span class="n">RunnableMap</span><span class="p">,</span>
    <span class="n">RunnablePassthrough</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseTool</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.utils._merge</span><span class="w"> </span><span class="kn">import</span> <span class="n">merge_dicts</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.utils.function_calling</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">convert_to_openai_function</span><span class="p">,</span>
    <span class="n">convert_to_openai_tool</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.utils.pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">TypeBaseModel</span><span class="p">,</span>
    <span class="n">is_basemodel_subclass</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.utils.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">secret_from_env</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ConfigDict</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">SecretStr</span><span class="p">,</span> <span class="n">model_validator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Self</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_ibm.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">async_gateway_error_handler</span><span class="p">,</span>
    <span class="n">check_duplicate_chat_params</span><span class="p">,</span>
    <span class="n">extract_chat_params</span><span class="p">,</span>
    <span class="n">gateway_error_handler</span><span class="p">,</span>
    <span class="n">resolve_watsonx_credentials</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_convert_dict_to_message</span><span class="p">(</span><span class="n">_dict</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseMessage</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Convert a dictionary to a LangChain message.</span>

<span class="sd">    Args:</span>
<span class="sd">        _dict: The dictionary.</span>
<span class="sd">        call_id: call id</span>

<span class="sd">    Returns:</span>
<span class="sd">        The LangChain message.</span>
<span class="sd">    """</span>
    <span class="n">role</span> <span class="o">=</span> <span class="n">_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"role"</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"name"</span><span class="p">)</span>
    <span class="n">id_</span> <span class="o">=</span> <span class="n">call_id</span>
    <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">"user"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"content"</span><span class="p">,</span> <span class="s2">""</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="n">id_</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">"assistant"</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"content"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">""</span>
        <span class="n">additional_kwargs</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">function_call</span> <span class="o">:=</span> <span class="n">_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"function_call"</span><span class="p">):</span>
            <span class="n">additional_kwargs</span><span class="p">[</span><span class="s2">"function_call"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">function_call</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reasoning_content</span> <span class="o">:=</span> <span class="n">_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"reasoning_content"</span><span class="p">):</span>
            <span class="n">additional_kwargs</span><span class="p">[</span><span class="s2">"reasoning_content"</span><span class="p">]</span> <span class="o">=</span> <span class="n">reasoning_content</span>
        <span class="n">tool_calls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">invalid_tool_calls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">raw_tool_calls</span> <span class="o">:=</span> <span class="n">_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"tool_calls"</span><span class="p">):</span>
            <span class="n">additional_kwargs</span><span class="p">[</span><span class="s2">"tool_calls"</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_tool_calls</span>
            <span class="k">for</span> <span class="n">raw_tool_call</span> <span class="ow">in</span> <span class="n">raw_tool_calls</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tool_calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse_tool_call</span><span class="p">(</span><span class="n">raw_tool_call</span><span class="p">,</span> <span class="n">return_id</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">invalid_tool_calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">make_invalid_tool_call</span><span class="p">(</span><span class="n">raw_tool_call</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">AIMessage</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
            <span class="n">additional_kwargs</span><span class="o">=</span><span class="n">additional_kwargs</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">id_</span><span class="p">,</span>
            <span class="n">tool_calls</span><span class="o">=</span><span class="n">tool_calls</span><span class="p">,</span>
            <span class="n">invalid_tool_calls</span><span class="o">=</span><span class="n">invalid_tool_calls</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">"system"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"content"</span><span class="p">,</span> <span class="s2">""</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">id_</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">"function"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">FunctionMessage</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"content"</span><span class="p">,</span> <span class="s2">""</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"name"</span><span class="p">)),</span> <span class="nb">id</span><span class="o">=</span><span class="n">id_</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">"tool"</span><span class="p">:</span>
        <span class="n">additional_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s2">"name"</span> <span class="ow">in</span> <span class="n">_dict</span><span class="p">:</span>
            <span class="n">additional_kwargs</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">_dict</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ToolMessage</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"content"</span><span class="p">,</span> <span class="s2">""</span><span class="p">),</span>
            <span class="n">tool_call_id</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"tool_call_id"</span><span class="p">)),</span>
            <span class="n">additional_kwargs</span><span class="o">=</span><span class="n">additional_kwargs</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">id_</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ChatMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"content"</span><span class="p">,</span> <span class="s2">""</span><span class="p">),</span> <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">id_</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_format_message_content</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Format message content."""</span>
    <span class="k">if</span> <span class="n">content</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># Remove unexpected block types</span>
        <span class="n">formatted_content</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                <span class="ow">and</span> <span class="s2">"type"</span> <span class="ow">in</span> <span class="n">block</span>
                <span class="ow">and</span> <span class="n">block</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"tool_use"</span>
            <span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">formatted_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">formatted_content</span> <span class="o">=</span> <span class="n">content</span>

    <span class="k">return</span> <span class="n">formatted_content</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_base62_encode</span><span class="p">(</span><span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Encodes a number in base62 and ensures result is of a specified length."""</span>
    <span class="n">base62</span> <span class="o">=</span> <span class="s2">"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">base62</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">base</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">base62</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">num</span><span class="p">:</span>
        <span class="n">num</span><span class="p">,</span> <span class="n">rem</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
        <span class="n">arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base62</span><span class="p">[</span><span class="n">rem</span><span class="p">])</span>
    <span class="n">arr</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="k">return</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_convert_tool_call_id_to_mistral_compatible</span><span class="p">(</span><span class="n">tool_call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Convert a tool call ID to a Mistral-compatible format"""</span>
    <span class="n">hash_bytes</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">tool_call_id</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
    <span class="n">hash_int</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">hash_bytes</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">"big"</span><span class="p">)</span>
    <span class="n">base62_str</span> <span class="o">=</span> <span class="n">_base62_encode</span><span class="p">(</span><span class="n">hash_int</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">base62_str</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">base62_str</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">base62_str</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_convert_message_to_dict</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">BaseMessage</span><span class="p">,</span> <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Convert a LangChain message to a dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        message: The LangChain message.</span>
<span class="sd">        model_id: Type of model to use.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The dictionary.</span>
<span class="sd">    """</span>
    <span class="n">message_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"content"</span><span class="p">:</span> <span class="n">_format_message_content</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">:=</span> <span class="n">message</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">message</span><span class="o">.</span><span class="n">additional_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"name"</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">message_dict</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

    <span class="c1"># populate role and additional message data</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">ChatMessage</span><span class="p">):</span>
        <span class="n">message_dict</span><span class="p">[</span><span class="s2">"role"</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">role</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">HumanMessage</span><span class="p">):</span>
        <span class="n">message_dict</span><span class="p">[</span><span class="s2">"role"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"user"</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">AIMessage</span><span class="p">):</span>
        <span class="n">message_dict</span><span class="p">[</span><span class="s2">"role"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"assistant"</span>
        <span class="k">if</span> <span class="s2">"function_call"</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">additional_kwargs</span><span class="p">:</span>
            <span class="n">message_dict</span><span class="p">[</span><span class="s2">"function_call"</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">additional_kwargs</span><span class="p">[</span><span class="s2">"function_call"</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span> <span class="ow">or</span> <span class="n">message</span><span class="o">.</span><span class="n">invalid_tool_calls</span><span class="p">:</span>
            <span class="n">message_dict</span><span class="p">[</span><span class="s2">"tool_calls"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">_lc_tool_call_to_watsonx_tool_call</span><span class="p">(</span><span class="n">tc</span><span class="p">)</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span>
            <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
                <span class="n">_lc_invalid_tool_call_to_watsonx_tool_call</span><span class="p">(</span><span class="n">tc</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">invalid_tool_calls</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="s2">"tool_calls"</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">additional_kwargs</span><span class="p">:</span>
            <span class="n">message_dict</span><span class="p">[</span><span class="s2">"tool_calls"</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">additional_kwargs</span><span class="p">[</span><span class="s2">"tool_calls"</span><span class="p">]</span>
            <span class="n">tool_call_supported_props</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">"type"</span><span class="p">,</span> <span class="s2">"function"</span><span class="p">}</span>
            <span class="n">message_dict</span><span class="p">[</span><span class="s2">"tool_calls"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tool_call</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tool_call_supported_props</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">message_dict</span><span class="p">[</span><span class="s2">"tool_calls"</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># If tool calls present, content null value should be None not empty string.</span>
        <span class="k">if</span> <span class="s2">"function_call"</span> <span class="ow">in</span> <span class="n">message_dict</span> <span class="ow">or</span> <span class="s2">"tool_calls"</span> <span class="ow">in</span> <span class="n">message_dict</span><span class="p">:</span>
            <span class="n">message_dict</span><span class="p">[</span><span class="s2">"content"</span><span class="p">]</span> <span class="o">=</span> <span class="n">message_dict</span><span class="p">[</span><span class="s2">"content"</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>

        <span class="c1"># Workaround for "mistralai/mistral-large" model when id &lt; 9</span>
        <span class="k">if</span> <span class="n">model_id</span> <span class="ow">and</span> <span class="n">model_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"mistralai"</span><span class="p">):</span>
            <span class="n">tool_calls</span> <span class="o">=</span> <span class="n">message_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"tool_calls"</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_calls</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">tool_calls</span>
                <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">tool_call_id</span> <span class="o">=</span> <span class="n">tool_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tool_call_id</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="n">tool_call_id</span> <span class="o">=</span> <span class="n">_convert_tool_call_id_to_mistral_compatible</span><span class="p">(</span>
                        <span class="n">tool_call_id</span>
                    <span class="p">)</span>

                <span class="n">message_dict</span><span class="p">[</span><span class="s2">"tool_calls"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">"id"</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_call_id</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">SystemMessage</span><span class="p">):</span>
        <span class="n">message_dict</span><span class="p">[</span><span class="s2">"role"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"system"</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">FunctionMessage</span><span class="p">):</span>
        <span class="n">message_dict</span><span class="p">[</span><span class="s2">"role"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"function"</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">ToolMessage</span><span class="p">):</span>
        <span class="n">message_dict</span><span class="p">[</span><span class="s2">"role"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"tool"</span>
        <span class="n">message_dict</span><span class="p">[</span><span class="s2">"tool_call_id"</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">tool_call_id</span>

        <span class="c1"># Workaround for "mistralai/mistral-large" model when tool_call_id &lt; 9</span>
        <span class="k">if</span> <span class="n">model_id</span> <span class="ow">and</span> <span class="n">model_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"mistralai"</span><span class="p">):</span>
            <span class="n">tool_call_id</span> <span class="o">=</span> <span class="n">message_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"tool_call_id"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tool_call_id</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">:</span>
                <span class="n">tool_call_id</span> <span class="o">=</span> <span class="n">_convert_tool_call_id_to_mistral_compatible</span><span class="p">(</span><span class="n">tool_call_id</span><span class="p">)</span>

            <span class="n">message_dict</span><span class="p">[</span><span class="s2">"tool_call_id"</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_call_id</span>

        <span class="n">supported_props</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"content"</span><span class="p">,</span> <span class="s2">"role"</span><span class="p">,</span> <span class="s2">"tool_call_id"</span><span class="p">}</span>
        <span class="n">message_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">message_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">supported_props</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Got unknown type </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">message_dict</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_convert_delta_to_message_chunk</span><span class="p">(</span>
    <span class="n">_dict</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">default_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseMessageChunk</span><span class="p">],</span>
    <span class="n">call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">is_first_tool_chunk</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseMessageChunk</span><span class="p">:</span>
    <span class="n">id_</span> <span class="o">=</span> <span class="n">call_id</span>
    <span class="n">role</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"role"</span><span class="p">))</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"content"</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">""</span><span class="p">)</span>
    <span class="n">additional_kwargs</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"function_call"</span><span class="p">):</span>
        <span class="n">function_call</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_dict</span><span class="p">[</span><span class="s2">"function_call"</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">"name"</span> <span class="ow">in</span> <span class="n">function_call</span> <span class="ow">and</span> <span class="n">function_call</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">function_call</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="n">additional_kwargs</span><span class="p">[</span><span class="s2">"function_call"</span><span class="p">]</span> <span class="o">=</span> <span class="n">function_call</span>
    <span class="n">tool_call_chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">raw_tool_calls</span> <span class="o">:=</span> <span class="n">_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"tool_calls"</span><span class="p">):</span>
        <span class="n">additional_kwargs</span><span class="p">[</span><span class="s2">"tool_calls"</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_tool_calls</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tool_call_chunks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">tool_call_chunk</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">rtc</span><span class="p">[</span><span class="s2">"function"</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"name"</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">is_first_tool_chunk</span> <span class="ow">or</span> <span class="p">(</span><span class="n">rtc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"id"</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="n">rtc</span><span class="p">[</span><span class="s2">"function"</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"arguments"</span><span class="p">),</span>
                    <span class="c1"># `id` is provided only for the first delta with unique tool_calls</span>
                    <span class="c1"># (multiple tool calls scenario)</span>
                    <span class="nb">id</span><span class="o">=</span><span class="n">rtc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"id"</span><span class="p">),</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">rtc</span><span class="p">[</span><span class="s2">"index"</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">rtc</span> <span class="ow">in</span> <span class="n">raw_tool_calls</span>
            <span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="n">reasoning_content</span> <span class="o">:=</span> <span class="n">_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"reasoning_content"</span><span class="p">):</span>
        <span class="n">additional_kwargs</span><span class="p">[</span><span class="s2">"reasoning_content"</span><span class="p">]</span> <span class="o">=</span> <span class="n">reasoning_content</span>

    <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">"user"</span> <span class="ow">or</span> <span class="n">default_class</span> <span class="o">==</span> <span class="n">HumanMessageChunk</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HumanMessageChunk</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">id_</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">"assistant"</span> <span class="ow">or</span> <span class="n">default_class</span> <span class="o">==</span> <span class="n">AIMessageChunk</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">AIMessageChunk</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
            <span class="n">additional_kwargs</span><span class="o">=</span><span class="n">additional_kwargs</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">id_</span><span class="p">,</span>
            <span class="n">tool_call_chunks</span><span class="o">=</span><span class="n">tool_call_chunks</span><span class="p">,</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">"system"</span> <span class="ow">or</span> <span class="n">default_class</span> <span class="o">==</span> <span class="n">SystemMessageChunk</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SystemMessageChunk</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">id_</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">"function"</span> <span class="ow">or</span> <span class="n">default_class</span> <span class="o">==</span> <span class="n">FunctionMessageChunk</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">FunctionMessageChunk</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">_dict</span><span class="p">[</span><span class="s2">"name"</span><span class="p">],</span> <span class="nb">id</span><span class="o">=</span><span class="n">id_</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">"tool"</span> <span class="ow">or</span> <span class="n">default_class</span> <span class="o">==</span> <span class="n">ToolMessageChunk</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ToolMessageChunk</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">tool_call_id</span><span class="o">=</span><span class="n">_dict</span><span class="p">[</span><span class="s2">"tool_call_id"</span><span class="p">],</span> <span class="nb">id</span><span class="o">=</span><span class="n">id_</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">role</span> <span class="ow">or</span> <span class="n">default_class</span> <span class="o">==</span> <span class="n">ChatMessageChunk</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ChatMessageChunk</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">id_</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default_class</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">id_</span><span class="p">)</span>  <span class="c1"># type: ignore</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_convert_chunk_to_generation_chunk</span><span class="p">(</span>
    <span class="n">chunk</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">default_chunk_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span>
    <span class="n">is_first_tool_chunk</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">_prompt_tokens_included</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ChatGenerationChunk</span><span class="p">]:</span>
    <span class="n">token_usage</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"usage"</span><span class="p">)</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"choices"</span><span class="p">,</span> <span class="p">[])</span>

    <span class="n">usage_metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UsageMetadata</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_create_usage_metadata</span><span class="p">(</span><span class="n">token_usage</span><span class="p">,</span> <span class="n">_prompt_tokens_included</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">token_usage</span>
        <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># logprobs is implicitly None</span>
        <span class="n">generation_chunk</span> <span class="o">=</span> <span class="n">ChatGenerationChunk</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="n">default_chunk_class</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="n">usage_metadata</span><span class="o">=</span><span class="n">usage_metadata</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">generation_chunk</span>

    <span class="n">choice</span> <span class="o">=</span> <span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">choice</span><span class="p">[</span><span class="s2">"delta"</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">message_chunk</span> <span class="o">=</span> <span class="n">_convert_delta_to_message_chunk</span><span class="p">(</span>
        <span class="n">choice</span><span class="p">[</span><span class="s2">"delta"</span><span class="p">],</span> <span class="n">default_chunk_class</span><span class="p">,</span> <span class="n">chunk</span><span class="p">[</span><span class="s2">"id"</span><span class="p">],</span> <span class="n">is_first_tool_chunk</span>
    <span class="p">)</span>
    <span class="n">generation_info</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">finish_reason</span> <span class="o">:=</span> <span class="n">choice</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"finish_reason"</span><span class="p">):</span>
        <span class="n">generation_info</span><span class="p">[</span><span class="s2">"finish_reason"</span><span class="p">]</span> <span class="o">=</span> <span class="n">finish_reason</span>
        <span class="k">if</span> <span class="n">model_name</span> <span class="o">:=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"model"</span><span class="p">):</span>
            <span class="n">generation_info</span><span class="p">[</span><span class="s2">"model_name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_name</span>
        <span class="k">if</span> <span class="n">system_fingerprint</span> <span class="o">:=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"system_fingerprint"</span><span class="p">):</span>
            <span class="n">generation_info</span><span class="p">[</span><span class="s2">"system_fingerprint"</span><span class="p">]</span> <span class="o">=</span> <span class="n">system_fingerprint</span>

    <span class="n">logprobs</span> <span class="o">=</span> <span class="n">choice</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"logprobs"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logprobs</span><span class="p">:</span>
        <span class="n">generation_info</span><span class="p">[</span><span class="s2">"logprobs"</span><span class="p">]</span> <span class="o">=</span> <span class="n">logprobs</span>

    <span class="k">if</span> <span class="n">usage_metadata</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message_chunk</span><span class="p">,</span> <span class="n">AIMessageChunk</span><span class="p">):</span>
        <span class="n">message_chunk</span><span class="o">.</span><span class="n">usage_metadata</span> <span class="o">=</span> <span class="n">usage_metadata</span>

    <span class="n">generation_chunk</span> <span class="o">=</span> <span class="n">ChatGenerationChunk</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="n">message_chunk</span><span class="p">,</span> <span class="n">generation_info</span><span class="o">=</span><span class="n">generation_info</span> <span class="ow">or</span> <span class="kc">None</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">generation_chunk</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_FunctionCall</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>


<div class="viewcode-block" id="ChatWatsonx">
<a class="viewcode-back" href="../../ibm/chat_models/langchain_ibm.chat_models.ChatWatsonx.html#langchain_ibm.chat_models.ChatWatsonx">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ChatWatsonx</span><span class="p">(</span><span class="n">BaseChatModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""`IBM watsonx.ai` chat models integration.</span>

<span class="sd">    ???+ info "Setup"</span>

<span class="sd">        To use, you should have `langchain_ibm` python package installed,</span>
<span class="sd">        and the environment variable `WATSONX_APIKEY` set with your API key, or pass</span>
<span class="sd">        it as a named parameter `apikey` to the constructor.</span>

<span class="sd">        ```bash</span>
<span class="sd">        pip install -U langchain-ibm</span>

<span class="sd">        # or using uv</span>
<span class="sd">        uv add langchain-ibm</span>
<span class="sd">        ```</span>

<span class="sd">        ```bash</span>
<span class="sd">        export WATSONX_APIKEY="your-api-key"</span>
<span class="sd">        ```</span>

<span class="sd">    ??? info "Instantiate"</span>

<span class="sd">        Create a model instance with desired params. For example:</span>

<span class="sd">        ```python</span>
<span class="sd">        from langchain_ibm import ChatWatsonx</span>
<span class="sd">        from ibm_watsonx_ai.foundation_models.schema import TextChatParameters</span>

<span class="sd">        parameters = TextChatParameters(</span>
<span class="sd">            top_p=1, temperature=0.5, max_completion_tokens=None</span>
<span class="sd">        )</span>

<span class="sd">        model = ChatWatsonx(</span>
<span class="sd">            model_id="meta-llama/llama-3-3-70b-instruct",</span>
<span class="sd">            url="https://us-south.ml.cloud.ibm.com",</span>
<span class="sd">            project_id="*****",</span>
<span class="sd">            params=parameters,</span>
<span class="sd">            # apikey="*****"</span>
<span class="sd">        )</span>
<span class="sd">        ```</span>

<span class="sd">    ??? info "Invoke"</span>

<span class="sd">        Generate a response from the model:</span>

<span class="sd">        ```python</span>
<span class="sd">        messages = [</span>
<span class="sd">            (</span>
<span class="sd">                "system",</span>
<span class="sd">                "You are a helpful translator. Translate the user sentence to French.",</span>
<span class="sd">            ),</span>
<span class="sd">            ("human", "I love programming."),</span>
<span class="sd">        ]</span>
<span class="sd">        model.invoke(messages)</span>
<span class="sd">        ```</span>

<span class="sd">        Results in an `AIMessage` response:</span>

<span class="sd">        ```python</span>
<span class="sd">        AIMessage(</span>
<span class="sd">            content="J'adore programmer.",</span>
<span class="sd">            additional_kwargs={},</span>
<span class="sd">            response_metadata={</span>
<span class="sd">                "token_usage": {</span>
<span class="sd">                    "completion_tokens": 7,</span>
<span class="sd">                    "prompt_tokens": 30,</span>
<span class="sd">                    "total_tokens": 37,</span>
<span class="sd">                },</span>
<span class="sd">                "model_name": "ibm/granite-3-3-8b-instruct",</span>
<span class="sd">                "system_fingerprint": "",</span>
<span class="sd">                "finish_reason": "stop",</span>
<span class="sd">            },</span>
<span class="sd">            id="chatcmpl-529352c4-93ba-4801-8f1d-a3b4e3935194---daed91fb74d0405f200db1e63da9a48a---7a3ef799-4413-47e4-b24c-85d267e37fa2",</span>
<span class="sd">            usage_metadata={"input_tokens": 30, "output_tokens": 7, "total_tokens": 37},</span>
<span class="sd">        )</span>
<span class="sd">        ```</span>

<span class="sd">    ??? info "Stream"</span>

<span class="sd">        Stream a response from the model:</span>

<span class="sd">        ```python</span>
<span class="sd">        for chunk in model.stream(messages):</span>
<span class="sd">            print(chunk.text)</span>
<span class="sd">        ```</span>

<span class="sd">        Results in a sequence of `AIMessageChunk` objects with partial content:</span>

<span class="sd">        ```python</span>
<span class="sd">        AIMessageChunk(content="", id="run--e48a38d3-1500-4b5e-870c-6313e8cff775")</span>
<span class="sd">        AIMessageChunk(content="J", id="run--e48a38d3-1500-4b5e-870c-6313e8cff775")</span>
<span class="sd">        AIMessageChunk(content="'", id="run--e48a38d3-1500-4b5e-870c-6313e8cff775")</span>
<span class="sd">        AIMessageChunk(content="ad", id="run--e48a38d3-1500-4b5e-870c-6313e8cff775")</span>
<span class="sd">        AIMessageChunk(content="ore", id="run--e48a38d3-1500-4b5e-870c-6313e8cff775")</span>
<span class="sd">        AIMessageChunk(</span>
<span class="sd">            content=" programmer", id="run--e48a38d3-1500-4b5e-870c-6313e8cff775"</span>
<span class="sd">        )</span>
<span class="sd">        AIMessageChunk(content=".", id="run--e48a38d3-1500-4b5e-870c-6313e8cff775")</span>
<span class="sd">        AIMessageChunk(</span>
<span class="sd">            content="",</span>
<span class="sd">            response_metadata={</span>
<span class="sd">                "finish_reason": "stop",</span>
<span class="sd">                "model_name": "ibm/granite-3-3-8b-instruct",</span>
<span class="sd">            },</span>
<span class="sd">            id="run--e48a38d3-1500-4b5e-870c-6313e8cff775",</span>
<span class="sd">        )</span>
<span class="sd">        AIMessageChunk(</span>
<span class="sd">            content="",</span>
<span class="sd">            id="run--e48a38d3-1500-4b5e-870c-6313e8cff775",</span>
<span class="sd">            usage_metadata={"input_tokens": 30, "output_tokens": 7, "total_tokens": 37},</span>
<span class="sd">        )</span>
<span class="sd">        ```</span>

<span class="sd">        To collect the full message, you can concatenate the chunks:</span>

<span class="sd">        ```python</span>
<span class="sd">        stream = model.stream(messages)</span>
<span class="sd">        full = next(stream)</span>
<span class="sd">        for chunk in stream:</span>
<span class="sd">            full += chunk</span>

<span class="sd">        full</span>
<span class="sd">        ```</span>

<span class="sd">        ```python</span>
<span class="sd">        AIMessageChunk(</span>
<span class="sd">            content="J'adore programmer.",</span>
<span class="sd">            response_metadata={</span>
<span class="sd">                "finish_reason": "stop",</span>
<span class="sd">                "model_name": "ibm/granite-3-3-8b-instruct",</span>
<span class="sd">            },</span>
<span class="sd">            id="chatcmpl-88a48b71-c149-4a0c-9c02-d6b97ca5dc6c---b7ba15879a8c5283b1e8a3b8db0229f0---0037ca4f-8a74-4f84-a46c-ab3fd1294f24",</span>
<span class="sd">            usage_metadata={"input_tokens": 30, "output_tokens": 7, "total_tokens": 37},</span>
<span class="sd">        )</span>
<span class="sd">        ```</span>

<span class="sd">    ??? info "Async"</span>

<span class="sd">        Asynchronous equivalents of `invoke`, `stream`, and `batch` are also available:</span>

<span class="sd">        ```python</span>
<span class="sd">        # Invoke</span>
<span class="sd">        await model.ainvoke(messages)</span>

<span class="sd">        # Stream</span>
<span class="sd">        async for chunk in model.astream(messages):</span>
<span class="sd">            print(chunk.text)</span>

<span class="sd">        # Batch</span>
<span class="sd">        await model.abatch([messages])</span>
<span class="sd">        ```</span>

<span class="sd">        Results in an `AIMessage` response:</span>

<span class="sd">        ```python</span>
<span class="sd">        AIMessage(</span>
<span class="sd">            content="J'adore programmer.",</span>
<span class="sd">            additional_kwargs={},</span>
<span class="sd">            response_metadata={</span>
<span class="sd">                "token_usage": {</span>
<span class="sd">                    "completion_tokens": 7,</span>
<span class="sd">                    "prompt_tokens": 30,</span>
<span class="sd">                    "total_tokens": 37,</span>
<span class="sd">                },</span>
<span class="sd">                "model_name": "ibm/granite-3-3-8b-instruct",</span>
<span class="sd">                "system_fingerprint": "",</span>
<span class="sd">                "finish_reason": "stop",</span>
<span class="sd">            },</span>
<span class="sd">            id="chatcmpl-5bef2d81-ef56-463b-a8fa-c2bcc2a3c348---821e7750d18925f2b36226db66667e26---6396c786-9da9-4468-883e-11ed90a05937",</span>
<span class="sd">            usage_metadata={"input_tokens": 30, "output_tokens": 7, "total_tokens": 37},</span>
<span class="sd">        )</span>
<span class="sd">        ```</span>

<span class="sd">        For batched calls, results in a `list[AIMessage]`.</span>

<span class="sd">    ??? info "Tool calling"</span>

<span class="sd">        ```python</span>
<span class="sd">        from pydantic import BaseModel, Field</span>


<span class="sd">        class GetWeather(BaseModel):</span>
<span class="sd">            '''Get the current weather in a given location'''</span>

<span class="sd">            location: str = Field(</span>
<span class="sd">                ..., description="The city and state, e.g. San Francisco, CA"</span>
<span class="sd">            )</span>


<span class="sd">        class GetPopulation(BaseModel):</span>
<span class="sd">            '''Get the current population in a given location'''</span>

<span class="sd">            location: str = Field(</span>
<span class="sd">                ..., description="The city and state, e.g. San Francisco, CA"</span>
<span class="sd">            )</span>


<span class="sd">        model_with_tools = model.bind_tools(</span>
<span class="sd">            [GetWeather, GetPopulation]</span>
<span class="sd">            # strict = True  # Enforce tool args schema is respected</span>
<span class="sd">        )</span>
<span class="sd">        ai_msg = model_with_tools.invoke(</span>
<span class="sd">            "Which city is hotter today and which is bigger: LA or NY?"</span>
<span class="sd">        )</span>
<span class="sd">        ai_msg.tool_calls</span>
<span class="sd">        ```</span>

<span class="sd">        ```python</span>
<span class="sd">        [</span>
<span class="sd">            {</span>
<span class="sd">                "name": "GetWeather",</span>
<span class="sd">                "args": {"location": "Los Angeles, CA"},</span>
<span class="sd">                "id": "chatcmpl-tool-59632abcee8f48a18a5f3a81422b917b",</span>
<span class="sd">                "type": "tool_call",</span>
<span class="sd">            },</span>
<span class="sd">            {</span>
<span class="sd">                "name": "GetWeather",</span>
<span class="sd">                "args": {"location": "New York, NY"},</span>
<span class="sd">                "id": "chatcmpl-tool-c6f3b033b4594918bb53f656525b0979",</span>
<span class="sd">                "type": "tool_call",</span>
<span class="sd">            },</span>
<span class="sd">            {</span>
<span class="sd">                "name": "GetPopulation",</span>
<span class="sd">                "args": {"location": "Los Angeles, CA"},</span>
<span class="sd">                "id": "chatcmpl-tool-175a23281e4747ea81cbe472b8e47012",</span>
<span class="sd">                "type": "tool_call",</span>
<span class="sd">            },</span>
<span class="sd">            {</span>
<span class="sd">                "name": "GetPopulation",</span>
<span class="sd">                "args": {"location": "New York, NY"},</span>
<span class="sd">                "id": "chatcmpl-tool-e1ccc534835945aebab708eb5e685bf7",</span>
<span class="sd">                "type": "tool_call",</span>
<span class="sd">            },</span>
<span class="sd">        ]</span>
<span class="sd">        ```</span>

<span class="sd">    ??? info "Reasoning output"</span>

<span class="sd">        ```python</span>
<span class="sd">        from langchain_ibm import ChatWatsonx</span>
<span class="sd">        from ibm_watsonx_ai.foundation_models.schema import TextChatParameters</span>

<span class="sd">        parameters = TextChatParameters(</span>
<span class="sd">            include_reasoning=True, reasoning_effort="medium"</span>
<span class="sd">        )</span>

<span class="sd">        model = ChatWatsonx(</span>
<span class="sd">            model_id="openai/gpt-oss-120b",</span>
<span class="sd">            url="https://us-south.ml.cloud.ibm.com",</span>
<span class="sd">            project_id="*****",</span>
<span class="sd">            params=parameters,</span>
<span class="sd">            # apikey="*****"</span>
<span class="sd">        )</span>

<span class="sd">        response = model.invoke("What is 3^3?")</span>

<span class="sd">        # Response text</span>
<span class="sd">        print(f"Output: {response.content}")</span>

<span class="sd">        # Reasoning summaries</span>
<span class="sd">        print(f"Reasoning: {response.additional_kwargs['reasoning_content']}")</span>
<span class="sd">        ```</span>

<span class="sd">        ```txt</span>
<span class="sd">        Output: 3^3 = 27</span>
<span class="sd">        Reasoning: The user asks "What is 3^3?" That's 27. Provide answer.</span>
<span class="sd">        ```</span>

<span class="sd">        !!! version-added "Added in version 0.3.19: Updated `AIMessage` format"</span>
<span class="sd">            [`langchain-ibm &gt;= 0.3.19`](https://pypi.org/project/langchain-ibm/#history)</span>
<span class="sd">            allows users to set Reasoning output parameters and will format output from</span>
<span class="sd">            reasoning summaries into `additional_kwargs` field.</span>

<span class="sd">    ??? info "Structured output"</span>

<span class="sd">        ```python</span>
<span class="sd">        from pydantic import BaseModel, Field</span>


<span class="sd">        class Joke(BaseModel):</span>
<span class="sd">            '''Joke to tell user.'''</span>

<span class="sd">            setup: str = Field(description="The setup of the joke")</span>
<span class="sd">            punchline: str = Field(description="The punchline to the joke")</span>
<span class="sd">            rating: int | None = Field(description="How funny the joke is, 1 to 10")</span>


<span class="sd">        structured_model = model.with_structured_output(Joke)</span>
<span class="sd">        structured_model.invoke("Tell me a joke about cats")</span>
<span class="sd">        ```</span>

<span class="sd">        ```python</span>
<span class="sd">        Joke(</span>
<span class="sd">            setup="Why was the cat sitting on the computer?",</span>
<span class="sd">            punchline="To keep an eye on the mouse!",</span>
<span class="sd">            rating=None,</span>
<span class="sd">        )</span>
<span class="sd">        ```</span>

<span class="sd">        See `with_structured_output` for more info.</span>

<span class="sd">    ??? info "JSON mode"</span>

<span class="sd">        ```python</span>
<span class="sd">        json_model = model.bind(response_format={"type": "json_object"})</span>
<span class="sd">        ai_msg = json_model.invoke(</span>
<span class="sd">            â€œReturn JSON with 'random_ints': an array of 10 random integers from 0â€“99.â€</span>
<span class="sd">        )</span>
<span class="sd">        ai_msg.content</span>
<span class="sd">        ```</span>

<span class="sd">        ```txt</span>
<span class="sd">        '{\\n  "random_ints": [12, 34, 56, 78, 10, 22, 44, 66, 88, 99]\\n}'</span>
<span class="sd">        ```</span>

<span class="sd">    ??? info "Image input"</span>

<span class="sd">        ```python</span>
<span class="sd">        import base64</span>
<span class="sd">        import httpx</span>
<span class="sd">        from langchain.messages import HumanMessage</span>

<span class="sd">        image_url = "https://upload.wikimedia.org/wikipedia/commons/thumb/d/dd/Gfp-wisconsin-madison-the-nature-boardwalk.jpg/2560px-Gfp-wisconsin-madison-the-nature-boardwalk.jpg"</span>
<span class="sd">        image_data = base64.b64encode(httpx.get(image_url).content).decode("utf-8")</span>
<span class="sd">        message = HumanMessage(</span>
<span class="sd">            content=[</span>
<span class="sd">                {"type": "text", "text": "describe the weather in this image"},</span>
<span class="sd">                {</span>
<span class="sd">                    "type": "image_url",</span>
<span class="sd">                    "image_url": {"url": f"data:image/jpeg;base64,{image_data}"},</span>
<span class="sd">                },</span>
<span class="sd">            ]</span>
<span class="sd">        )</span>

<span class="sd">        ai_msg = model.invoke([message])</span>
<span class="sd">        ai_msg.content</span>
<span class="sd">        ```</span>

<span class="sd">        ```txt</span>
<span class="sd">        "The weather in the image presents a clear, sunny day with good visibility</span>
<span class="sd">        and no immediate signs of rain or strong winds. The vibrant blue sky with</span>
<span class="sd">        scattered white clouds gives the impression of a tranquil, pleasant day</span>
<span class="sd">        conducive to outdoor activities."</span>
<span class="sd">        ```</span>

<span class="sd">    ??? info "Token usage"</span>

<span class="sd">        ```python</span>
<span class="sd">        ai_msg = model.invoke(messages)</span>
<span class="sd">        ai_msg.usage_metadata</span>
<span class="sd">        ```</span>

<span class="sd">        ```txt</span>
<span class="sd">        {'input_tokens': 30, 'output_tokens': 7, 'total_tokens': 37}</span>
<span class="sd">        ```</span>

<span class="sd">        ```python</span>
<span class="sd">        stream = model.stream(messages)</span>
<span class="sd">        full = next(stream)</span>
<span class="sd">        for chunk in stream:</span>
<span class="sd">            full += chunk</span>
<span class="sd">        full.usage_metadata</span>
<span class="sd">        ```</span>

<span class="sd">        ```txt</span>
<span class="sd">        {'input_tokens': 30, 'output_tokens': 7, 'total_tokens': 37}</span>
<span class="sd">        ```</span>

<span class="sd">    ??? info "Logprobs"</span>

<span class="sd">        ```python</span>
<span class="sd">        logprobs_model = model.bind(logprobs=True)</span>
<span class="sd">        ai_msg = logprobs_model.invoke(messages)</span>
<span class="sd">        ai_msg.response_metadata["logprobs"]</span>
<span class="sd">        ```</span>

<span class="sd">        ```txt</span>
<span class="sd">        {</span>
<span class="sd">            'content': [</span>
<span class="sd">                {</span>
<span class="sd">                    'token': 'J',</span>
<span class="sd">                    'logprob': -0.0017940393</span>
<span class="sd">                },</span>
<span class="sd">                {</span>
<span class="sd">                    'token': "'",</span>
<span class="sd">                    'logprob': -1.7523613e-05</span>
<span class="sd">                },</span>
<span class="sd">                {</span>
<span class="sd">                    'token': 'ad',</span>
<span class="sd">                    'logprob': -0.16112353</span>
<span class="sd">                },</span>
<span class="sd">                {</span>
<span class="sd">                    'token': 'ore',</span>
<span class="sd">                    'logprob': -0.0003091811</span>
<span class="sd">                },</span>
<span class="sd">                {</span>
<span class="sd">                    'token': ' programmer',</span>
<span class="sd">                    'logprob': -0.24849245</span>
<span class="sd">                },</span>
<span class="sd">                {</span>
<span class="sd">                    'token': '.',</span>
<span class="sd">                    'logprob': -2.5033638e-05</span>
<span class="sd">                },</span>
<span class="sd">                {</span>
<span class="sd">                    'token': '&lt;|end_of_text|&gt;',</span>
<span class="sd">                    'logprob': -7.080781e-05</span>
<span class="sd">                }</span>
<span class="sd">            ]</span>
<span class="sd">        }</span>
<span class="sd">        ```</span>

<span class="sd">    ??? info "Response metadata"</span>

<span class="sd">        ```python</span>
<span class="sd">        ai_msg = model.invoke(messages)</span>
<span class="sd">        ai_msg.response_metadata</span>
<span class="sd">        ```</span>

<span class="sd">        ```txt</span>
<span class="sd">        {</span>
<span class="sd">            'token_usage': {</span>
<span class="sd">                'completion_tokens': 7,</span>
<span class="sd">                'prompt_tokens': 30,</span>
<span class="sd">                'total_tokens': 37</span>
<span class="sd">            },</span>
<span class="sd">            'model_name': 'ibm/granite-3-3-8b-instruct',</span>
<span class="sd">            'system_fingerprint': '',</span>
<span class="sd">            'finish_reason': 'stop'</span>
<span class="sd">        }</span>
<span class="sd">        ```</span>
<span class="sd">    """</span>

    <span class="n">model_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""Type of model to use."""</span>

    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Name or alias of the foundation model to use.  </span>
<span class="sd">    When using IBMâ€™s watsonx.ai Model Gateway (public preview), you can specify any </span>
<span class="sd">    supported third-party modelâ€”OpenAI, Anthropic, NVIDIA, Cerebras, or IBMâ€™s own </span>
<span class="sd">    Granite seriesâ€”via a single, OpenAI-compatible interface. Models must be explicitly </span>
<span class="sd">    provisioned (opt-in) through the Gateway to ensure secure, vendor-agnostic access </span>
<span class="sd">    and easy switch-over without reconfiguration.</span>

<span class="sd">    For more details on configuration and usage, see [IBM watsonx Model Gateway docs](https://dataplatform.cloud.ibm.com/docs/content/wsj/analyze-data/fm-model-gateway.html?context=wx&amp;audience=wdp)</span>
<span class="sd">    """</span>

    <span class="n">deployment_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""Type of deployed model to use."""</span>

    <span class="n">project_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""ID of the Watson Studio project."""</span>

    <span class="n">space_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""ID of the Watson Studio space."""</span>

    <span class="n">url</span><span class="p">:</span> <span class="n">SecretStr</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">alias</span><span class="o">=</span><span class="s2">"url"</span><span class="p">,</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">secret_from_env</span><span class="p">(</span><span class="s2">"WATSONX_URL"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>  <span class="c1"># type: ignore[assignment]</span>
    <span class="p">)</span>
<span class="w">    </span><span class="sd">"""URL to the Watson Machine Learning or CPD instance."""</span>

    <span class="n">apikey</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SecretStr</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">alias</span><span class="o">=</span><span class="s2">"apikey"</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="n">secret_from_env</span><span class="p">(</span><span class="s2">"WATSONX_APIKEY"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="p">)</span>
<span class="w">    </span><span class="sd">"""API key to the Watson Machine Learning or CPD instance."""</span>

    <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SecretStr</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">alias</span><span class="o">=</span><span class="s2">"token"</span><span class="p">,</span> <span class="n">default_factory</span><span class="o">=</span><span class="n">secret_from_env</span><span class="p">(</span><span class="s2">"WATSONX_TOKEN"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="p">)</span>
<span class="w">    </span><span class="sd">"""Token to the CPD instance."""</span>

    <span class="n">password</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SecretStr</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">alias</span><span class="o">=</span><span class="s2">"password"</span><span class="p">,</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">secret_from_env</span><span class="p">(</span><span class="s2">"WATSONX_PASSWORD"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
    <span class="p">)</span>
<span class="w">    </span><span class="sd">"""Password to the CPD instance."""</span>

    <span class="n">username</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SecretStr</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">alias</span><span class="o">=</span><span class="s2">"username"</span><span class="p">,</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">secret_from_env</span><span class="p">(</span><span class="s2">"WATSONX_USERNAME"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
    <span class="p">)</span>
<span class="w">    </span><span class="sd">"""Username to the CPD instance."""</span>

    <span class="n">instance_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SecretStr</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">alias</span><span class="o">=</span><span class="s2">"instance_id"</span><span class="p">,</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">secret_from_env</span><span class="p">(</span><span class="s2">"WATSONX_INSTANCE_ID"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
    <span class="p">)</span>
<span class="w">    </span><span class="sd">"""Instance_id of the CPD instance."""</span>

    <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SecretStr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""Version of the CPD instance."""</span>

    <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">TextChatParameters</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""Model parameters to use during request generation.</span>

<span class="sd">    !!! note</span>
<span class="sd">        `ValueError` is raised if the same Chat generation parameter is provided</span>
<span class="sd">        within the params attribute and as keyword argument.</span>
<span class="sd">    """</span>

    <span class="n">frequency_penalty</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""Positive values penalize new tokens based on their existing frequency in the </span>
<span class="sd">    text so far, decreasing the model's likelihood to repeat the same line verbatim."""</span>

    <span class="n">logprobs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""Whether to return log probabilities of the output tokens or not. </span>
<span class="sd">    If true, returns the log probabilities of each output token returned </span>
<span class="sd">    in the content of message."""</span>

    <span class="n">top_logprobs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""An integer specifying the number of most likely tokens to return at each </span>
<span class="sd">    token position, each with an associated log probability. The option logprobs </span>
<span class="sd">    must be set to true if this parameter is used."""</span>

    <span class="n">max_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""The maximum number of tokens that can be generated in the chat completion. </span>
<span class="sd">    The total length of input tokens and generated tokens is limited by the </span>
<span class="sd">    model's context length. </span>
<span class="sd">    This value is now deprecated in favor of 'max_completion_tokens' parameter."""</span>

    <span class="n">max_completion_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""The maximum number of tokens that can be generated in the chat completion. </span>
<span class="sd">    The total length of input tokens and generated tokens is limited by the </span>
<span class="sd">    model's context length."""</span>

    <span class="n">n</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""How many chat completion choices to generate for each input message. </span>
<span class="sd">    Note that you will be charged based on the number of generated tokens across </span>
<span class="sd">    all of the choices. Keep n as 1 to minimize costs."""</span>

    <span class="n">presence_penalty</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""Positive values penalize new tokens based on whether they appear in the </span>
<span class="sd">    text so far, increasing the model's likelihood to talk about new topics."""</span>

    <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""What sampling temperature to use. Higher values like 0.8 will make the </span>
<span class="sd">    output more random, while lower values like 0.2 will make it more focused </span>
<span class="sd">    and deterministic.</span>
<span class="sd">    </span>
<span class="sd">    We generally recommend altering this or top_p but not both."""</span>

    <span class="n">response_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""The chat response format parameters."""</span>

    <span class="n">top_p</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""An alternative to sampling with temperature, called nucleus sampling, </span>
<span class="sd">    where the model considers the results of the tokens with top_p probability </span>
<span class="sd">    mass. So 0.1 means only the tokens comprising the top 10% probability mass </span>
<span class="sd">    are considered.</span>

<span class="sd">    We generally recommend altering this or temperature but not both."""</span>

    <span class="n">time_limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""Time limit in milliseconds - if not completed within this time, </span>
<span class="sd">    generation will stop."""</span>

    <span class="n">logit_bias</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""Increasing or decreasing probability of tokens being selected </span>
<span class="sd">    during generation."""</span>

    <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""Random number generator seed to use in sampling mode </span>
<span class="sd">    for experimental repeatability."""</span>

    <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""Stop sequences are one or more strings which will cause the text generation </span>
<span class="sd">    to stop if/when they are produced as part of the output."""</span>

    <span class="n">verify</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""You can pass one of following as verify:</span>
<span class="sd">        * the path to a CA_BUNDLE file</span>
<span class="sd">        * the path of directory with certificates of trusted CAs</span>
<span class="sd">        * True - default path to truststore will be taken</span>
<span class="sd">        * False - no verification will be made"""</span>

    <span class="n">validate_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="w">    </span><span class="sd">"""Model ID validation."""</span>

    <span class="n">streaming</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="w">    </span><span class="sd">"""Whether to stream the results or not."""</span>

    <span class="n">watsonx_model</span><span class="p">:</span> <span class="n">ModelInference</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1">#: :meta private:</span>

    <span class="n">watsonx_model_gateway</span><span class="p">:</span> <span class="n">Gateway</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>  <span class="c1">#: :meta private:</span>

    <span class="n">watsonx_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">APIClient</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">populate_by_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_lc_serializable</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_llm_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return the type of chat model."""</span>
        <span class="k">return</span> <span class="s2">"watsonx-chat"</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_ls_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LangSmithParams</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Get standard params for tracing."""</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_ls_params</span><span class="p">(</span><span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">"ls_provider"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"ibm"</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">"ls_model_name"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span>
        <span class="k">return</span> <span class="n">params</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lc_secrets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Mapping of secret environment variables."""</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">"url"</span><span class="p">:</span> <span class="s2">"WATSONX_URL"</span><span class="p">,</span>
            <span class="s2">"apikey"</span><span class="p">:</span> <span class="s2">"WATSONX_APIKEY"</span><span class="p">,</span>
            <span class="s2">"token"</span><span class="p">:</span> <span class="s2">"WATSONX_TOKEN"</span><span class="p">,</span>
            <span class="s2">"password"</span><span class="p">:</span> <span class="s2">"WATSONX_PASSWORD"</span><span class="p">,</span>
            <span class="s2">"username"</span><span class="p">:</span> <span class="s2">"WATSONX_USERNAME"</span><span class="p">,</span>
            <span class="s2">"instance_id"</span><span class="p">:</span> <span class="s2">"WATSONX_INSTANCE_ID"</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">"after"</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Validate that credentials and python package exists in environment."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">BaseSchema</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">check_duplicate_chat_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">{</span>
                    <span class="n">param</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">ChatWatsonx</span><span class="o">.</span><span class="n">_get_supported_chat_params</span><span class="p">()</span>
                <span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model_gateway</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">"Passing the 'watsonx_model_gateway' parameter to the ChatWatsonx "</span>
                <span class="s2">"constructor is not supported yet."</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model</span><span class="p">,</span> <span class="n">ModelInference</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model</span><span class="p">,</span> <span class="s2">"model_id"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deployment_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model</span><span class="p">,</span> <span class="s2">"deployment_id"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model</span><span class="p">,</span> <span class="s2">"_client"</span><span class="p">),</span>
                <span class="s2">"default_project_id"</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">space_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model</span><span class="p">,</span> <span class="s2">"_client"</span><span class="p">),</span> <span class="s2">"default_space_id"</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model</span><span class="p">,</span> <span class="s2">"params"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">watsonx_client</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model</span><span class="p">,</span> <span class="s2">"_client"</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">watsonx_client</span><span class="p">,</span> <span class="n">APIClient</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deployment_id</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"The parameters 'model', 'model_id' and 'deployment_id' are "</span>
                    <span class="s2">"mutually exclusive. Please specify exactly one of these "</span>
                    <span class="s2">"parameters when initializing ChatWatsonx."</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">watsonx_model_gateway</span> <span class="o">=</span> <span class="n">Gateway</span><span class="p">(</span>
                    <span class="n">api_client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">watsonx_client</span><span class="p">,</span>
                    <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verify</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model_gateway</span> <span class="o">=</span> <span class="n">watsonx_model_gateway</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">watsonx_model</span> <span class="o">=</span> <span class="n">ModelInference</span><span class="p">(</span>
                    <span class="n">model_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="p">,</span>
                    <span class="n">deployment_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deployment_id</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                    <span class="n">api_client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">watsonx_client</span><span class="p">,</span>
                    <span class="n">project_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span>
                    <span class="n">space_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">space_id</span><span class="p">,</span>
                    <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verify</span><span class="p">,</span>
                    <span class="n">validate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validate_model</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model</span> <span class="o">=</span> <span class="n">watsonx_model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deployment_id</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"The parameters 'model', 'model_id' and 'deployment_id' are "</span>
                    <span class="s2">"mutually exclusive. Please specify exactly one of these "</span>
                    <span class="s2">"parameters when initializing ChatWatsonx."</span>
                <span class="p">)</span>

            <span class="n">credentials</span> <span class="o">=</span> <span class="n">resolve_watsonx_credentials</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
                <span class="n">apikey</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apikey</span><span class="p">,</span>
                <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
                <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                <span class="n">instance_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance_id</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verify</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">watsonx_model_gateway</span> <span class="o">=</span> <span class="n">Gateway</span><span class="p">(</span>
                    <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">,</span>
                    <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verify</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model_gateway</span> <span class="o">=</span> <span class="n">watsonx_model_gateway</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">watsonx_model</span> <span class="o">=</span> <span class="n">ModelInference</span><span class="p">(</span>
                    <span class="n">model_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="p">,</span>
                    <span class="n">deployment_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deployment_id</span><span class="p">,</span>
                    <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                    <span class="n">project_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span>
                    <span class="n">space_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">space_id</span><span class="p">,</span>
                    <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verify</span><span class="p">,</span>
                    <span class="n">validate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validate_model</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model</span> <span class="o">=</span> <span class="n">watsonx_model</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@gateway_error_handler</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_call_model_gateway</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model_gateway</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span>
        <span class="p">)</span>

    <span class="nd">@async_gateway_error_handler</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_acall_model_gateway</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model_gateway</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">acreate</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseMessage</span><span class="p">],</span>
        <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">run_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CallbackManagerForLLMRun</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatResult</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">streaming</span><span class="p">:</span>
            <span class="n">stream_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="p">(</span>
                <span class="n">messages</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="n">run_manager</span><span class="o">=</span><span class="n">run_manager</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">generate_from_stream</span><span class="p">(</span><span class="n">stream_iter</span><span class="p">)</span>

        <span class="n">message_dicts</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_message_dicts</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">updated_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model_gateway</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">call_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">updated_params</span><span class="p">}</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_model_gateway</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">message_dicts</span><span class="p">,</span> <span class="o">**</span><span class="n">call_kwargs</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">message_dicts</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">kwargs</span> <span class="o">|</span> <span class="p">{</span><span class="s2">"params"</span><span class="p">:</span> <span class="n">updated_params</span><span class="p">})</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_chat_result</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_agenerate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseMessage</span><span class="p">],</span>
        <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">run_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AsyncCallbackManagerForLLMRun</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatResult</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">streaming</span><span class="p">:</span>
            <span class="n">stream_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_astream</span><span class="p">(</span>
                <span class="n">messages</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="n">run_manager</span><span class="o">=</span><span class="n">run_manager</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">agenerate_from_stream</span><span class="p">(</span><span class="n">stream_iter</span><span class="p">)</span>

        <span class="n">message_dicts</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_message_dicts</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">updated_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model_gateway</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">call_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">updated_params</span><span class="p">}</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acall_model_gateway</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">message_dicts</span><span class="p">,</span> <span class="o">**</span><span class="n">call_kwargs</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model</span><span class="o">.</span><span class="n">achat</span><span class="p">(</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">message_dicts</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">kwargs</span> <span class="o">|</span> <span class="p">{</span><span class="s2">"params"</span><span class="p">:</span> <span class="n">updated_params</span><span class="p">})</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_chat_result</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_stream</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseMessage</span><span class="p">],</span>
        <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">run_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CallbackManagerForLLMRun</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">ChatGenerationChunk</span><span class="p">]:</span>
        <span class="n">message_dicts</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_message_dicts</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">updated_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model_gateway</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">call_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">updated_params</span><span class="p">,</span> <span class="s2">"stream"</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="n">chunk_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_model_gateway</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">message_dicts</span><span class="p">,</span> <span class="o">**</span><span class="n">call_kwargs</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">call_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="s2">"params"</span><span class="p">:</span> <span class="n">updated_params</span><span class="p">}</span>
            <span class="n">chunk_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model</span><span class="o">.</span><span class="n">chat_stream</span><span class="p">(</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">message_dicts</span><span class="p">,</span> <span class="o">**</span><span class="n">call_kwargs</span>
            <span class="p">)</span>

        <span class="n">default_chunk_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseMessageChunk</span><span class="p">]</span> <span class="o">=</span> <span class="n">AIMessageChunk</span>
        <span class="n">is_first_tool_chunk</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">_prompt_tokens_included</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunk_iter</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">chunk</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="n">generation_chunk</span> <span class="o">=</span> <span class="n">_convert_chunk_to_generation_chunk</span><span class="p">(</span>
                <span class="n">chunk</span><span class="p">,</span> <span class="n">default_chunk_class</span><span class="p">,</span> <span class="n">is_first_tool_chunk</span><span class="p">,</span> <span class="n">_prompt_tokens_included</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">generation_chunk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">generation_chunk</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="s2">"usage_metadata"</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">generation_chunk</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">usage_metadata</span>
            <span class="p">):</span>
                <span class="n">_prompt_tokens_included</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">default_chunk_class</span> <span class="o">=</span> <span class="n">generation_chunk</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="n">logprobs</span> <span class="o">=</span> <span class="p">(</span><span class="n">generation_chunk</span><span class="o">.</span><span class="n">generation_info</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"logprobs"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">run_manager</span><span class="p">:</span>
                <span class="n">run_manager</span><span class="o">.</span><span class="n">on_llm_new_token</span><span class="p">(</span>
                    <span class="n">generation_chunk</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">generation_chunk</span><span class="p">,</span> <span class="n">logprobs</span><span class="o">=</span><span class="n">logprobs</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">generation_chunk</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="s2">"tool_calls"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">generation_chunk</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">,</span> <span class="nb">list</span>
            <span class="p">):</span>
                <span class="n">first_tool_call</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">generation_chunk</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">generation_chunk</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first_tool_call</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">first_tool_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"name"</span><span class="p">):</span>
                    <span class="n">is_first_tool_chunk</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">yield</span> <span class="n">generation_chunk</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_astream</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseMessage</span><span class="p">],</span>
        <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">run_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AsyncCallbackManagerForLLMRun</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">ChatGenerationChunk</span><span class="p">]:</span>
        <span class="n">message_dicts</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_message_dicts</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">updated_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model_gateway</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">call_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">updated_params</span><span class="p">,</span> <span class="s2">"stream"</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="n">chunk_iter</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acall_model_gateway</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">message_dicts</span><span class="p">,</span> <span class="o">**</span><span class="n">call_kwargs</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">call_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="s2">"params"</span><span class="p">:</span> <span class="n">updated_params</span><span class="p">}</span>
            <span class="n">chunk_iter</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">watsonx_model</span><span class="o">.</span><span class="n">achat_stream</span><span class="p">(</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">message_dicts</span><span class="p">,</span> <span class="o">**</span><span class="n">call_kwargs</span>
            <span class="p">)</span>

        <span class="n">default_chunk_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseMessageChunk</span><span class="p">]</span> <span class="o">=</span> <span class="n">AIMessageChunk</span>
        <span class="n">is_first_tool_chunk</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">_prompt_tokens_included</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunk_iter</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">chunk</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="n">generation_chunk</span> <span class="o">=</span> <span class="n">_convert_chunk_to_generation_chunk</span><span class="p">(</span>
                <span class="n">chunk</span><span class="p">,</span>
                <span class="n">default_chunk_class</span><span class="p">,</span>
                <span class="n">is_first_tool_chunk</span><span class="p">,</span>
                <span class="n">_prompt_tokens_included</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">generation_chunk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">generation_chunk</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="s2">"usage_metadata"</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">generation_chunk</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">usage_metadata</span>
            <span class="p">):</span>
                <span class="n">_prompt_tokens_included</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">default_chunk_class</span> <span class="o">=</span> <span class="n">generation_chunk</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="n">logprobs</span> <span class="o">=</span> <span class="p">(</span><span class="n">generation_chunk</span><span class="o">.</span><span class="n">generation_info</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"logprobs"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">run_manager</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">run_manager</span><span class="o">.</span><span class="n">on_llm_new_token</span><span class="p">(</span>
                    <span class="n">generation_chunk</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                    <span class="n">chunk</span><span class="o">=</span><span class="n">generation_chunk</span><span class="p">,</span>
                    <span class="n">logprobs</span><span class="o">=</span><span class="n">logprobs</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">generation_chunk</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="s2">"tool_calls"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">generation_chunk</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">,</span> <span class="nb">list</span>
            <span class="p">):</span>
                <span class="n">first_tool_call</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">generation_chunk</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">generation_chunk</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first_tool_call</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">first_tool_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"name"</span><span class="p">):</span>
                    <span class="n">is_first_tool_chunk</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">yield</span> <span class="n">generation_chunk</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_merge_params</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">param_updates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ChatWatsonx</span><span class="o">.</span><span class="n">_get_supported_chat_params</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">param_updates</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"params"</span><span class="p">):</span>
            <span class="n">merged_params</span> <span class="o">=</span> <span class="n">merge_dicts</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">param_updates</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">merged_params</span> <span class="o">=</span> <span class="n">params</span> <span class="o">|</span> <span class="n">param_updates</span>

        <span class="k">return</span> <span class="n">merged_params</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_message_dicts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseMessage</span><span class="p">],</span> <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">extract_chat_params</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">params</span> <span class="ow">and</span> <span class="s2">"stop_sequences"</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"`stop_sequences` found in both the input and default params."</span>
                <span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})</span> <span class="o">|</span> <span class="p">{</span><span class="s2">"stop_sequences"</span><span class="p">:</span> <span class="n">stop</span><span class="p">}</span>
        <span class="n">message_dicts</span> <span class="o">=</span> <span class="p">[</span><span class="n">_convert_message_to_dict</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">message_dicts</span><span class="p">,</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_chat_result</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">generation_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatResult</span><span class="p">:</span>
        <span class="n">generations</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"error"</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"error"</span><span class="p">))</span>

        <span class="n">token_usage</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"usage"</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">"choices"</span><span class="p">]:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">_convert_dict_to_message</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">"message"</span><span class="p">],</span> <span class="n">response</span><span class="p">[</span><span class="s2">"id"</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">token_usage</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">AIMessage</span><span class="p">):</span>
                <span class="n">message</span><span class="o">.</span><span class="n">usage_metadata</span> <span class="o">=</span> <span class="n">_create_usage_metadata</span><span class="p">(</span><span class="n">token_usage</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">generation_info</span> <span class="o">=</span> <span class="n">generation_info</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">generation_info</span><span class="p">[</span><span class="s2">"finish_reason"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"finish_reason"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"finish_reason"</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="n">generation_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"finish_reason"</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="s2">"logprobs"</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                <span class="n">generation_info</span><span class="p">[</span><span class="s2">"logprobs"</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">"logprobs"</span><span class="p">]</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="n">ChatGeneration</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">generation_info</span><span class="o">=</span><span class="n">generation_info</span><span class="p">)</span>
            <span class="n">generations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
        <span class="n">llm_output</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"token_usage"</span><span class="p">:</span> <span class="n">token_usage</span><span class="p">,</span>
            <span class="s2">"model_name"</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"model_id"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="p">),</span>
            <span class="s2">"system_fingerprint"</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"system_fingerprint"</span><span class="p">,</span> <span class="s2">""</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">ChatResult</span><span class="p">(</span><span class="n">generations</span><span class="o">=</span><span class="n">generations</span><span class="p">,</span> <span class="n">llm_output</span><span class="o">=</span><span class="n">llm_output</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_supported_chat_params</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># watsonx.ai Chat API doc: https://cloud.ibm.com/apidocs/watsonx-ai#text-chat</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s2">"frequency_penalty"</span><span class="p">,</span>
            <span class="s2">"logprobs"</span><span class="p">,</span>
            <span class="s2">"top_logprobs"</span><span class="p">,</span>
            <span class="s2">"max_tokens"</span><span class="p">,</span>
            <span class="s2">"max_completion_tokens"</span><span class="p">,</span>
            <span class="s2">"n"</span><span class="p">,</span>
            <span class="s2">"presence_penalty"</span><span class="p">,</span>
            <span class="s2">"response_format"</span><span class="p">,</span>
            <span class="s2">"temperature"</span><span class="p">,</span>
            <span class="s2">"top_p"</span><span class="p">,</span>
            <span class="s2">"time_limit"</span><span class="p">,</span>
            <span class="s2">"logit_bias"</span><span class="p">,</span>
            <span class="s2">"seed"</span><span class="p">,</span>
            <span class="s2">"stop"</span><span class="p">,</span>
        <span class="p">]</span>

<div class="viewcode-block" id="ChatWatsonx.bind_functions">
<a class="viewcode-back" href="../../ibm/chat_models/langchain_ibm.chat_models.ChatWatsonx.html#langchain_ibm.chat_models.ChatWatsonx.bind_functions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">bind_functions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">functions</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">BaseTool</span><span class="p">]],</span>
        <span class="n">function_call</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Union</span><span class="p">[</span><span class="n">_FunctionCall</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"auto"</span><span class="p">,</span> <span class="s2">"none"</span><span class="p">]]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Runnable</span><span class="p">[</span><span class="n">LanguageModelInput</span><span class="p">,</span> <span class="n">BaseMessage</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Bind functions (and other objects) to this chat model.</span>

<span class="sd">        Assumes model is compatible with IBM watsonx.ai function-calling API.</span>

<span class="sd">        Args:</span>
<span class="sd">            functions: A list of function definitions to bind to this chat model.</span>
<span class="sd">                Can be  a dictionary, pydantic model, or callable. Pydantic</span>
<span class="sd">                models and callables will be automatically converted to</span>
<span class="sd">                their schema dictionary representation.</span>
<span class="sd">            function_call: Which function to require the model to call.</span>
<span class="sd">                Must be the name of the single provided function or</span>
<span class="sd">                "auto" to automatically determine which function to call</span>
<span class="sd">                (if any).</span>
<span class="sd">            **kwargs: Any additional parameters to pass to the Runnable constructor.</span>
<span class="sd">        """</span>

        <span class="n">formatted_functions</span> <span class="o">=</span> <span class="p">[</span><span class="n">convert_to_openai_function</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">function_call</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">function_call</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="n">function_call</span><span class="p">}</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">function_call</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">function_call</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"auto"</span><span class="p">,</span> <span class="s2">"none"</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">function_call</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">function_call</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">formatted_functions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"When specifying `function_call`, you must provide exactly one "</span>
                    <span class="s2">"function."</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">function_call</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">formatted_functions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">!=</span> <span class="n">function_call</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"Function call </span><span class="si">{</span><span class="n">function_call</span><span class="si">}</span><span class="s2"> was specified, but the only "</span>
                    <span class="sa">f</span><span class="s2">"provided function was </span><span class="si">{</span><span class="n">formatted_functions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'name'</span><span class="p">]</span><span class="si">}</span><span class="s2">."</span>
                <span class="p">)</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="s2">"function_call"</span><span class="p">:</span> <span class="n">function_call</span><span class="p">}</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span>
            <span class="n">functions</span><span class="o">=</span><span class="n">formatted_functions</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ChatWatsonx.bind_tools">
<a class="viewcode-back" href="../../ibm/chat_models/langchain_ibm.chat_models.ChatWatsonx.html#langchain_ibm.chat_models.ChatWatsonx.bind_tools">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">bind_tools</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">BaseTool</span><span class="p">]],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"auto"</span><span class="p">,</span> <span class="s2">"none"</span><span class="p">,</span> <span class="s2">"required"</span><span class="p">,</span> <span class="s2">"any"</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Runnable</span><span class="p">[</span><span class="n">LanguageModelInput</span><span class="p">,</span> <span class="n">BaseMessage</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Bind tool-like objects to this chat model.</span>

<span class="sd">        Args:</span>
<span class="sd">            tools: A list of tool definitions to bind to this chat model.</span>
<span class="sd">                Can be  a dictionary, pydantic model, callable, or BaseTool. Pydantic</span>
<span class="sd">                models, callables, and BaseTools will be automatically converted to</span>
<span class="sd">                their schema dictionary representation.</span>
<span class="sd">            tool_choice: Which tool to require the model to call. Options are:</span>

<span class="sd">                - `str` of the form `'&lt;&lt;tool_name&gt;&gt;'`: calls `&lt;&lt;tool_name&gt;&gt;` tool.</span>
<span class="sd">                - `'auto'`: automatically selects a tool (including no tool).</span>
<span class="sd">                - `'none'`: does not call a tool.</span>
<span class="sd">                - `'any'` or `'required'` or `True`: force at least one tool to be called.</span>
<span class="sd">                - `dict` of the form `{"type": "function", "function": {"name": &lt;&lt;tool_name&gt;&gt;}}`: calls `&lt;&lt;tool_name&gt;&gt;` tool.</span>
<span class="sd">                - `False` or `None`: no effect, default OpenAI behavior.</span>

<span class="sd">            kwargs: Any additional parameters are passed directly to `bind`.</span>
<span class="sd">        """</span>  <span class="c1"># noqa: E501</span>
        <span class="n">formatted_tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">convert_to_openai_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tool_choice</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_choice</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="c1"># tool_choice is a tool/function name</span>
                <span class="k">if</span> <span class="n">tool_choice</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"auto"</span><span class="p">,</span> <span class="s2">"none"</span><span class="p">,</span> <span class="s2">"any"</span><span class="p">,</span> <span class="s2">"required"</span><span class="p">):</span>
                    <span class="n">tool_choice</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"function"</span><span class="p">,</span>
                        <span class="s2">"function"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="n">tool_choice</span><span class="p">},</span>
                    <span class="p">}</span>
                <span class="c1"># We support 'any' since other models use this instead of 'required'.</span>
                <span class="k">if</span> <span class="n">tool_choice</span> <span class="o">==</span> <span class="s2">"any"</span><span class="p">:</span>
                    <span class="n">tool_choice</span> <span class="o">=</span> <span class="s2">"required"</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_choice</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">tool_choice</span> <span class="o">=</span> <span class="s2">"required"</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_choice</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">tool_names</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">formatted_tool</span><span class="p">[</span><span class="s2">"function"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">formatted_tool</span> <span class="ow">in</span> <span class="n">formatted_tools</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="n">tool_name</span> <span class="o">==</span> <span class="n">tool_choice</span><span class="p">[</span><span class="s2">"function"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">tool_name</span> <span class="ow">in</span> <span class="n">tool_names</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">"Tool choice </span><span class="si">{</span><span class="n">tool_choice</span><span class="si">}</span><span class="s2"> was specified, but the only "</span>
                        <span class="sa">f</span><span class="s2">"provided tools were </span><span class="si">{</span><span class="n">tool_names</span><span class="si">}</span><span class="s2">."</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"Unrecognized tool_choice type. Expected str, bool or dict. "</span>
                    <span class="sa">f</span><span class="s2">"Received: </span><span class="si">{</span><span class="n">tool_choice</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_choice</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">"tool_choice_option"</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_choice</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">"tool_choice"</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_choice</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"tool_choice_option"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"auto"</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">tools</span><span class="o">=</span><span class="n">formatted_tools</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="ChatWatsonx.with_structured_output">
<a class="viewcode-back" href="../../ibm/chat_models/langchain_ibm.chat_models.ChatWatsonx.html#langchain_ibm.chat_models.ChatWatsonx.with_structured_output">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">with_structured_output</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">Type</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
            <span class="s2">"function_calling"</span><span class="p">,</span> <span class="s2">"json_mode"</span><span class="p">,</span> <span class="s2">"json_schema"</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">"function_calling"</span><span class="p">,</span>
        <span class="n">include_raw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Runnable</span><span class="p">[</span><span class="n">LanguageModelInput</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Model wrapper that returns outputs formatted to match the given schema.</span>

<span class="sd">        Args:</span>
<span class="sd">            schema: The output schema. Can be passed in as:</span>

<span class="sd">                - a JSON Schema,</span>
<span class="sd">                - a TypedDict class,</span>
<span class="sd">                - or a Pydantic class,</span>

<span class="sd">                If `schema` is a Pydantic class then the model output will be a</span>
<span class="sd">                Pydantic instance of that class, and the model-generated fields will be</span>
<span class="sd">                validated by the Pydantic class. Otherwise the model output will be a</span>
<span class="sd">                dict and will not be validated.</span>

<span class="sd">            method: The method for steering model generation, one of:</span>

<span class="sd">                - `'function_calling'`: uses tool-calling features.</span>
<span class="sd">                - `'json_schema'`: uses dedicated structured output features.</span>
<span class="sd">                - `'json_mode'`: uses JSON mode.</span>

<span class="sd">            include_raw:</span>
<span class="sd">                If False then only the parsed structured output is returned. If</span>
<span class="sd">                an error occurs during model output parsing it will be raised. If True</span>
<span class="sd">                then both the raw model response (a BaseMessage) and the parsed model</span>
<span class="sd">                response will be returned. If an error occurs during output parsing it</span>
<span class="sd">                will be caught and returned as well. The final output is always a dict</span>
<span class="sd">                with keys `'raw'`, `'parsed'`, and `'parsing_error'`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A Runnable that takes same inputs as a `langchain_core.language_models.chat.BaseChatModel`.</span>

<span class="sd">            If `include_raw` is True, then Runnable outputs a dict with keys:</span>

<span class="sd">            - `'raw'`: BaseMessage</span>
<span class="sd">            - `'parsed'`: None if there was a parsing error, otherwise the type depends on the `schema` as described above.</span>
<span class="sd">            - `'parsing_error'`: Optional[BaseException]</span>

<span class="sd">        ??? note "Example: `schema=Pydantic` class, `method='function_calling'`, `include_raw=True`"</span>

<span class="sd">            ```python</span>
<span class="sd">            from langchain_ibm import ChatWatsonx</span>
<span class="sd">            from pydantic import BaseModel</span>


<span class="sd">            class AnswerWithJustification(BaseModel):</span>
<span class="sd">                '''An answer to the user question along with justification for the answer.'''</span>

<span class="sd">                answer: str</span>
<span class="sd">                justification: str</span>


<span class="sd">            model = ChatWatsonx(...)</span>
<span class="sd">            structured_model = model.with_structured_output(</span>
<span class="sd">                AnswerWithJustification, include_raw=True</span>
<span class="sd">            )</span>

<span class="sd">            structured_model.invoke(</span>
<span class="sd">                "What weighs more a pound of bricks or a pound of feathers"</span>
<span class="sd">            )</span>
<span class="sd">            ```</span>

<span class="sd">            ```python</span>
<span class="sd">            {</span>
<span class="sd">                "raw": AIMessage(</span>
<span class="sd">                    content="",</span>
<span class="sd">                    additional_kwargs={</span>
<span class="sd">                        "tool_calls": [</span>
<span class="sd">                            {</span>
<span class="sd">                                "id": "call_Ao02pnFYXD6GN1yzc0uXPsvF",</span>
<span class="sd">                                "function": {</span>
<span class="sd">                                    "arguments": '{"answer":"They weigh the same.","justification":"Both a pound of bricks and a pound of feathers weigh one pound. The weight is the same, but the volume or density of the objects may differ."}',</span>
<span class="sd">                                    "name": "AnswerWithJustification",</span>
<span class="sd">                                },</span>
<span class="sd">                                "type": "function",</span>
<span class="sd">                            }</span>
<span class="sd">                        ]</span>
<span class="sd">                    },</span>
<span class="sd">                ),</span>
<span class="sd">                "parsed": AnswerWithJustification(</span>
<span class="sd">                    answer="They weigh the same.",</span>
<span class="sd">                    justification="Both a pound of bricks and a pound of feathers weigh one pound. The weight is the same, but the volume or density of the objects may differ.",</span>
<span class="sd">                ),</span>
<span class="sd">                "parsing_error": None,</span>
<span class="sd">            }</span>
<span class="sd">            ```</span>

<span class="sd">        ??? note "Example: `schema=JSON` schema, `method='function_calling'`, `include_raw=False`"</span>

<span class="sd">            ```python</span>
<span class="sd">            from langchain_ibm import ChatWatsonx</span>
<span class="sd">            from pydantic import BaseModel</span>
<span class="sd">            from langchain_core.utils.function_calling import convert_to_openai_tool</span>


<span class="sd">            class AnswerWithJustification(BaseModel):</span>
<span class="sd">                '''An answer to the user question along with justification for the answer.'''</span>

<span class="sd">                answer: str</span>
<span class="sd">                justification: str</span>


<span class="sd">            dict_schema = convert_to_openai_tool(AnswerWithJustification)</span>
<span class="sd">            model = ChatWatsonx(...)</span>
<span class="sd">            structured_model = model.with_structured_output(dict_schema)</span>

<span class="sd">            structured_model.invoke(</span>
<span class="sd">                "What weighs more a pound of bricks or a pound of feathers"</span>
<span class="sd">            )</span>
<span class="sd">            ```</span>

<span class="sd">            ```python</span>
<span class="sd">            {</span>
<span class="sd">                "answer": "They weigh the same",</span>
<span class="sd">                "justification": "Both a pound of bricks and a pound of feathers weigh one pound. The weight is the same, but the volume and density of the two substances differ.",</span>
<span class="sd">            }</span>
<span class="sd">            ```</span>

<span class="sd">        ??? note "Example: `schema=Pydantic` class, `method='json_schema'`, `include_raw=True`"</span>

<span class="sd">            ```python</span>
<span class="sd">            from langchain_ibm import ChatWatsonx</span>
<span class="sd">            from pydantic import BaseModel</span>


<span class="sd">            class AnswerWithJustification(BaseModel):</span>
<span class="sd">                '''An answer to the user question along with justification for the answer.'''</span>

<span class="sd">                answer: str</span>
<span class="sd">                justification: str</span>


<span class="sd">            model = ChatWatsonx(...)</span>
<span class="sd">            structured_model = model.with_structured_output(</span>
<span class="sd">                AnswerWithJustification, method="json_schema", include_raw=True</span>
<span class="sd">            )</span>

<span class="sd">            structured_model.invoke(</span>
<span class="sd">                "What weighs more a pound of bricks or a pound of feathers"</span>
<span class="sd">            )</span>
<span class="sd">            ```</span>

<span class="sd">            ```python</span>
<span class="sd">            {</span>
<span class="sd">                "raw": AIMessage(</span>
<span class="sd">                    content="",</span>
<span class="sd">                    additional_kwargs={</span>
<span class="sd">                        "tool_calls": [</span>
<span class="sd">                            {</span>
<span class="sd">                                "id": "chatcmpl-tool-bfbd6f6dd33b438990c5ddf277485971",</span>
<span class="sd">                                "type": "function",</span>
<span class="sd">                                "function": {</span>
<span class="sd">                                    "name": "AnswerWithJustification",</span>
<span class="sd">                                    "arguments": '{"answer": "They weigh the same", "justification": "A pound is a unit of weight or mass, so both a pound of bricks and a pound of feathers weigh the same amount, one pound."}',</span>
<span class="sd">                                },</span>
<span class="sd">                            }</span>
<span class="sd">                        ]</span>
<span class="sd">                    },</span>
<span class="sd">                    response_metadata={</span>
<span class="sd">                        "token_usage": {</span>
<span class="sd">                            "completion_tokens": 45,</span>
<span class="sd">                            "prompt_tokens": 275,</span>
<span class="sd">                            "total_tokens": 320,</span>
<span class="sd">                        },</span>
<span class="sd">                        "model_name": "meta-llama/llama-3-3-70b-instruct",</span>
<span class="sd">                        "system_fingerprint": "",</span>
<span class="sd">                        "finish_reason": "stop",</span>
<span class="sd">                    },</span>
<span class="sd">                    id="chatcmpl-461ca5bd-1982-412c-b886-017c483bf481---8c18b06eead65ae4691364798787bda7---71896588-efa5-439f-a25f-d1abfe289f5a",</span>
<span class="sd">                    tool_calls=[</span>
<span class="sd">                        {</span>
<span class="sd">                            "name": "AnswerWithJustification",</span>
<span class="sd">                            "args": {</span>
<span class="sd">                                "answer": "They weigh the same",</span>
<span class="sd">                                "justification": "A pound is a unit of weight or mass, so both a pound of bricks and a pound of feathers weigh the same amount, one pound.",</span>
<span class="sd">                            },</span>
<span class="sd">                            "id": "chatcmpl-tool-bfbd6f6dd33b438990c5ddf277485971",</span>
<span class="sd">                            "type": "tool_call",</span>
<span class="sd">                        }</span>
<span class="sd">                    ],</span>
<span class="sd">                    usage_metadata={</span>
<span class="sd">                        "input_tokens": 275,</span>
<span class="sd">                        "output_tokens": 45,</span>
<span class="sd">                        "total_tokens": 320,</span>
<span class="sd">                    },</span>
<span class="sd">                ),</span>
<span class="sd">                "parsed": AnswerWithJustification(</span>
<span class="sd">                    answer="They weigh the same",</span>
<span class="sd">                    justification="A pound is a unit of weight or mass, so both a pound of bricks and a pound of feathers weigh the same amount, one pound.",</span>
<span class="sd">                ),</span>
<span class="sd">                "parsing_error": None,</span>
<span class="sd">            }</span>
<span class="sd">            ```</span>

<span class="sd">        ??? note "Example: `schema=function` schema, `method='json_schema'`, `include_raw=False`"</span>

<span class="sd">            ```python</span>
<span class="sd">            from langchain_ibm import ChatWatsonx</span>
<span class="sd">            from pydantic import BaseModel</span>

<span class="sd">            function__schema = {</span>
<span class="sd">                "name": "AnswerWithJustification",</span>
<span class="sd">                "description": "An answer to the user question along with justification for the answer.",</span>
<span class="sd">                "parameters": {</span>
<span class="sd">                    "type": "object",</span>
<span class="sd">                    "properties": {</span>
<span class="sd">                        "answer": {"type": "string"},</span>
<span class="sd">                        "justification": {</span>
<span class="sd">                            "description": "A justification for the answer.",</span>
<span class="sd">                            "type": "string",</span>
<span class="sd">                        },</span>
<span class="sd">                    },</span>
<span class="sd">                    "required": ["answer"],</span>
<span class="sd">                },</span>
<span class="sd">            }</span>

<span class="sd">            model = ChatWatsonx(...)</span>
<span class="sd">            structured_model = model.with_structured_output(</span>
<span class="sd">                function_schema, method="json_schema", include_raw=False</span>
<span class="sd">            )</span>

<span class="sd">            structured_model.invoke(</span>
<span class="sd">                "What weighs more a pound of bricks or a pound of feathers"</span>
<span class="sd">            )</span>
<span class="sd">            ```</span>

<span class="sd">            ```python</span>
<span class="sd">            {</span>
<span class="sd">                "answer": "They weigh the same",</span>
<span class="sd">                "justification": "Both a pound of bricks and a pound of feathers weigh one pound. The weight is the same, but the volume and density of the two substances differ.",</span>
<span class="sd">            }</span>
<span class="sd">            ```</span>

<span class="sd">        ??? note "Example: `schema=Pydantic` class, `method='json_mode'`, `include_raw=True`"</span>

<span class="sd">            ```python</span>
<span class="sd">            from langchain_ibm import ChatWatsonx</span>
<span class="sd">            from pydantic import BaseModel</span>


<span class="sd">            class AnswerWithJustification(BaseModel):</span>
<span class="sd">                answer: str</span>
<span class="sd">                justification: str</span>


<span class="sd">            model = ChatWatsonx(...)</span>
<span class="sd">            structured_model = model.with_structured_output(</span>
<span class="sd">                AnswerWithJustification, method="json_mode", include_raw=True</span>
<span class="sd">            )</span>

<span class="sd">            structured_model.invoke(</span>
<span class="sd">                "Answer the following question. "</span>
<span class="sd">                "Make sure to return a JSON blob with keys 'answer' and 'justification'.\\n\\n"</span>
<span class="sd">                "What's heavier a pound of bricks or a pound of feathers?"</span>
<span class="sd">            )</span>
<span class="sd">            ```</span>

<span class="sd">            ```python</span>
<span class="sd">            {</span>
<span class="sd">                "raw": AIMessage(</span>
<span class="sd">                    content='{\\n    "answer": "They are both the same weight.",\\n    "justification": "Both a pound of bricks and a pound of feathers weigh one pound. The difference lies in the volume and density of the materials, not the weight." \\n}'</span>
<span class="sd">                ),</span>
<span class="sd">                "parsed": AnswerWithJustification(</span>
<span class="sd">                    answer="They are both the same weight.",</span>
<span class="sd">                    justification="Both a pound of bricks and a pound of feathers weigh one pound. The difference lies in the volume and density of the materials, not the weight.",</span>
<span class="sd">                ),</span>
<span class="sd">                "parsing_error": None,</span>
<span class="sd">            }</span>
<span class="sd">            ```</span>

<span class="sd">        ??? note "Example: `schema=None`, `method='json_mode'`, `include_raw=True`"</span>

<span class="sd">            ```python</span>
<span class="sd">            from langchain_ibm import ChatWatsonx</span>

<span class="sd">            model = ChatWatsonx(...)</span>
<span class="sd">            structured_model = model.with_structured_output(</span>
<span class="sd">                method="json_mode", include_raw=True</span>
<span class="sd">            )</span>

<span class="sd">            structured_model.invoke(</span>
<span class="sd">                "Answer the following question. "</span>
<span class="sd">                "Make sure to return a JSON blob with keys 'answer' and 'justification'.\\n\\n"</span>
<span class="sd">                "What's heavier a pound of bricks or a pound of feathers?"</span>
<span class="sd">            )</span>
<span class="sd">            ```</span>

<span class="sd">            ```python</span>
<span class="sd">            {</span>
<span class="sd">                "raw": AIMessage(</span>
<span class="sd">                    content='{\\n    "answer": "They are both the same weight.",\\n    "justification": "Both a pound of bricks and a pound of feathers weigh one pound. The difference lies in the volume and density of the materials, not the weight." \\n}'</span>
<span class="sd">                ),</span>
<span class="sd">                "parsed": {</span>
<span class="sd">                    "answer": "They are both the same weight.",</span>
<span class="sd">                    "justification": "Both a pound of bricks and a pound of feathers weigh one pound. The difference lies in the volume and density of the materials, not the weight.",</span>
<span class="sd">                },</span>
<span class="sd">                "parsing_error": None,</span>
<span class="sd">            }</span>
<span class="sd">            ```</span>

<span class="sd">        """</span>  <span class="c1"># noqa: E501</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Received unsupported arguments </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">is_pydantic_schema</span> <span class="o">=</span> <span class="n">_is_pydantic_class</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">"function_calling"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"schema must be specified when method is not 'json_mode'. "</span>
                    <span class="s2">"Received None."</span>
                <span class="p">)</span>
            <span class="n">formatted_tool</span> <span class="o">=</span> <span class="n">convert_to_openai_tool</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
            <span class="n">tool_name</span> <span class="o">=</span> <span class="n">formatted_tool</span><span class="p">[</span><span class="s2">"function"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_tools</span><span class="p">(</span>
                <span class="p">[</span><span class="n">schema</span><span class="p">],</span>
                <span class="n">tool_choice</span><span class="o">=</span><span class="n">tool_name</span><span class="p">,</span>
                <span class="n">ls_structured_output_format</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">"kwargs"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"method"</span><span class="p">:</span> <span class="n">method</span><span class="p">},</span>
                    <span class="s2">"schema"</span><span class="p">:</span> <span class="n">formatted_tool</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">is_pydantic_schema</span><span class="p">:</span>
                <span class="n">output_parser</span><span class="p">:</span> <span class="n">Runnable</span> <span class="o">=</span> <span class="n">PydanticToolsParser</span><span class="p">(</span>
                    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">schema</span><span class="p">],</span>  <span class="c1"># type: ignore[list-item]</span>
                    <span class="n">first_tool_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># type: ignore[list-item]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output_parser</span> <span class="o">=</span> <span class="n">JsonOutputKeyToolsParser</span><span class="p">(</span>
                    <span class="n">key_name</span><span class="o">=</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">first_tool_only</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">"json_mode"</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span>
                <span class="n">response_format</span><span class="o">=</span><span class="p">{</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"json_object"</span><span class="p">},</span>
                <span class="n">ls_structured_output_format</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">"kwargs"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"method"</span><span class="p">:</span> <span class="n">method</span><span class="p">},</span>
                    <span class="s2">"schema"</span><span class="p">:</span> <span class="n">schema</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="n">output_parser</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">PydanticOutputParser</span><span class="p">(</span><span class="n">pydantic_object</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
                <span class="k">if</span> <span class="n">is_pydantic_schema</span>
                <span class="k">else</span> <span class="n">JsonOutputParser</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">"json_schema"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"schema must be specified when method is not 'json_mode'. "</span>
                    <span class="s2">"Received None."</span>
                <span class="p">)</span>
            <span class="n">response_format</span> <span class="o">=</span> <span class="n">_convert_to_openai_response_format</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_pydantic_schema</span><span class="p">:</span>
                <span class="n">response_format</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"json_schema"</span><span class="p">,</span>
                    <span class="s2">"json_schema"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">"name"</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>  <span class="c1"># type: ignore[union-attr]</span>
                        <span class="s2">"description"</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">,</span>
                        <span class="s2">"schema"</span><span class="p">:</span> <span class="n">schema</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">(),</span>  <span class="c1"># type: ignore[union-attr]</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="n">bind_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="o">**</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">response_format</span><span class="o">=</span><span class="n">response_format</span><span class="p">,</span>
                    <span class="n">ls_structured_output_format</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">"kwargs"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"method"</span><span class="p">:</span> <span class="n">method</span><span class="p">},</span>
                        <span class="s2">"schema"</span><span class="p">:</span> <span class="n">convert_to_openai_tool</span><span class="p">(</span><span class="n">schema</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="p">}</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">**</span><span class="n">bind_kwargs</span><span class="p">)</span>
            <span class="n">output_parser</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">PydanticOutputParser</span><span class="p">(</span><span class="n">pydantic_object</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
                <span class="k">if</span> <span class="n">is_pydantic_schema</span>
                <span class="k">else</span> <span class="n">JsonOutputParser</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"Unrecognized method argument. Expected one of 'function_calling', "</span>
                <span class="sa">f</span><span class="s2">"'json_mode' or 'json_schema'. Received: '</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">'"</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">include_raw</span><span class="p">:</span>
            <span class="n">parser_assign</span> <span class="o">=</span> <span class="n">RunnablePassthrough</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">parsed</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">"raw"</span><span class="p">)</span> <span class="o">|</span> <span class="n">output_parser</span><span class="p">,</span> <span class="n">parsing_error</span><span class="o">=</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">parser_none</span> <span class="o">=</span> <span class="n">RunnablePassthrough</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">parsed</span><span class="o">=</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">parser_with_fallback</span> <span class="o">=</span> <span class="n">parser_assign</span><span class="o">.</span><span class="n">with_fallbacks</span><span class="p">(</span>
                <span class="p">[</span><span class="n">parser_none</span><span class="p">],</span> <span class="n">exception_key</span><span class="o">=</span><span class="s2">"parsing_error"</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">RunnableMap</span><span class="p">(</span><span class="n">raw</span><span class="o">=</span><span class="n">model</span><span class="p">)</span> <span class="o">|</span> <span class="n">parser_with_fallback</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model</span> <span class="o">|</span> <span class="n">output_parser</span></div>
</div>



<span class="k">def</span><span class="w"> </span><span class="nf">_is_pydantic_class</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_lc_tool_call_to_watsonx_tool_call</span><span class="p">(</span><span class="n">tool_call</span><span class="p">:</span> <span class="n">ToolCall</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"function"</span><span class="p">,</span>
        <span class="s2">"id"</span><span class="p">:</span> <span class="n">tool_call</span><span class="p">[</span><span class="s2">"id"</span><span class="p">],</span>
        <span class="s2">"function"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"name"</span><span class="p">:</span> <span class="n">tool_call</span><span class="p">[</span><span class="s2">"name"</span><span class="p">],</span>
            <span class="s2">"arguments"</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">tool_call</span><span class="p">[</span><span class="s2">"args"</span><span class="p">]),</span>
        <span class="p">},</span>
    <span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_lc_invalid_tool_call_to_watsonx_tool_call</span><span class="p">(</span>
    <span class="n">invalid_tool_call</span><span class="p">:</span> <span class="n">InvalidToolCall</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"function"</span><span class="p">,</span>
        <span class="s2">"id"</span><span class="p">:</span> <span class="n">invalid_tool_call</span><span class="p">[</span><span class="s2">"id"</span><span class="p">],</span>
        <span class="s2">"function"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"name"</span><span class="p">:</span> <span class="n">invalid_tool_call</span><span class="p">[</span><span class="s2">"name"</span><span class="p">],</span>
            <span class="s2">"arguments"</span><span class="p">:</span> <span class="n">invalid_tool_call</span><span class="p">[</span><span class="s2">"args"</span><span class="p">],</span>
        <span class="p">},</span>
    <span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_create_usage_metadata</span><span class="p">(</span>
    <span class="n">oai_token_usage</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">_prompt_tokens_included</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UsageMetadata</span><span class="p">:</span>
    <span class="n">input_tokens</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">oai_token_usage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"prompt_tokens"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">_prompt_tokens_included</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="p">)</span>
    <span class="n">output_tokens</span> <span class="o">=</span> <span class="n">oai_token_usage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"completion_tokens"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">total_tokens</span> <span class="o">=</span> <span class="n">oai_token_usage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"total_tokens"</span><span class="p">,</span> <span class="n">input_tokens</span> <span class="o">+</span> <span class="n">output_tokens</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">UsageMetadata</span><span class="p">(</span>
        <span class="n">input_tokens</span><span class="o">=</span><span class="n">input_tokens</span><span class="p">,</span>
        <span class="n">output_tokens</span><span class="o">=</span><span class="n">output_tokens</span><span class="p">,</span>
        <span class="n">total_tokens</span><span class="o">=</span><span class="n">total_tokens</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_convert_to_openai_response_format</span><span class="p">(</span>
    <span class="n">schema</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">type</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">TypeBaseModel</span><span class="p">]:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_basemodel_subclass</span><span class="p">(</span><span class="n">schema</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">schema</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="ow">and</span> <span class="s2">"json_schema"</span> <span class="ow">in</span> <span class="n">schema</span>
        <span class="ow">and</span> <span class="n">schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"type"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"json_schema"</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">schema</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">"name"</span> <span class="ow">in</span> <span class="n">schema</span> <span class="ow">and</span> <span class="s2">"schema"</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"json_schema"</span><span class="p">,</span> <span class="s2">"json_schema"</span><span class="p">:</span> <span class="n">schema</span><span class="p">}</span>

    <span class="n">function</span> <span class="o">=</span> <span class="n">convert_to_openai_function</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
    <span class="n">function</span><span class="p">[</span><span class="s2">"schema"</span><span class="p">]</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"parameters"</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"json_schema"</span><span class="p">,</span> <span class="s2">"json_schema"</span><span class="p">:</span> <span class="n">function</span><span class="p">}</span>
</pre></div>
</article>
</div>
</div>
<footer class="bd-footer-content">
</footer>
</main>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script defer="" src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer="" src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>
<footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
<div class="footer-items__start">
<div class="footer-item">
<p class="copyright">
    
      Â© Copyright 2025, LangChain Inc.
      <br/>
</p>
</div>
</div>
</div>
</footer>
</body>
</html>